<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COT Glance Board</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Sora:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      :root {
        --bg: #060d1d;
        --panel: #0f1d3a;
        --panel-soft: #142850;
        --line: #243d6f;
        --text: #eff4ff;
        --muted: #9db4df;
        --bull: #22c55e;
        --bear: #ef4444;
        --neutral: #94a3b8;
        --warn: #f97316;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: "Sora", sans-serif;
        background:
          radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.26), transparent 34%),
          radial-gradient(circle at 96% 4%, rgba(249, 115, 22, 0.24), transparent 30%),
          linear-gradient(160deg, #060d1d 0%, #091630 55%, #0e1f42 100%);
      }

      .wrap {
        width: min(1280px, calc(100% - 1rem));
        margin: 0 auto;
        padding: 1rem 0 1.5rem;
      }

      .top {
        border: 1px solid var(--line);
        border-radius: 24px;
        background: linear-gradient(145deg, rgba(15, 29, 58, 0.96), rgba(10, 21, 45, 0.96));
        padding: 0.95rem;
        margin-bottom: 0.8rem;
      }

      .top-row {
        display: grid;
        grid-template-columns: 1.2fr auto;
        gap: 0.8rem;
        align-items: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.28rem, 3.4vw, 2rem);
        letter-spacing: 0.01em;
      }

      .sub {
        margin: 0.18rem 0 0;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        justify-content: flex-end;
      }

      .btn {
        border: 1px solid #3d5f98;
        border-radius: 999px;
        padding: 0.45rem 0.84rem;
        background: linear-gradient(145deg, #234582, #173262);
        color: #e8f0ff;
        font-family: inherit;
        font-size: 0.79rem;
        font-weight: 700;
        cursor: pointer;
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: wait;
      }

      .chip-row {
        margin-top: 0.6rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      .chip {
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(14, 28, 58, 0.8);
        color: var(--muted);
        padding: 0.28rem 0.62rem;
        font-size: 0.74rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .tabs {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.5rem;
        margin-top: 0.75rem;
      }

      .tab {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 0.7rem;
        background: #0f2247;
        color: #aec3ea;
        font-family: inherit;
        font-size: 0.84rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        cursor: pointer;
      }

      .tab.active {
        color: #f3f7ff;
        border-color: #6ea0ef;
        background: linear-gradient(145deg, #234a8e, #183663);
        box-shadow: 0 10px 28px rgba(10, 25, 52, 0.45);
      }

      .alert {
        margin-top: 0.75rem;
        border: 1px solid #3a5f9b;
        border-radius: 16px;
        padding: 0.62rem 0.8rem;
        background: linear-gradient(145deg, rgba(29, 64, 129, 0.35), rgba(11, 27, 58, 0.92));
      }

      .alert b {
        font-size: 0.95rem;
      }

      .alert span {
        color: #cfdef7;
        font-size: 0.84rem;
      }

      .glance {
        margin-top: 0.82rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.6rem;
      }

      .card {
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 0.85rem;
        background: linear-gradient(180deg, rgba(15, 29, 58, 0.96), rgba(10, 20, 43, 0.96));
        min-height: 155px;
      }

      .label {
        margin: 0;
        color: var(--muted);
        font-size: 0.71rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .big {
        margin: 0.32rem 0 0;
        font-size: clamp(1.35rem, 3vw, 2.15rem);
        line-height: 1;
        font-weight: 800;
      }

      .mono {
        font-family: "IBM Plex Mono", monospace;
      }

      .delta {
        margin-top: 0.28rem;
        font-size: 0.82rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .up {
        color: var(--bull);
      }

      .down {
        color: var(--bear);
      }

      .flat {
        color: var(--neutral);
      }

      .gauge {
        margin-top: 0.6rem;
        height: 18px;
        position: relative;
        border-radius: 999px;
        border: 1px solid #30508b;
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.45), rgba(148, 163, 184, 0.18), rgba(34, 197, 94, 0.45));
      }

      .gauge-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 22px;
        background: #ffffff;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.9);
      }

      .range {
        margin-top: 0.7rem;
        height: 15px;
        position: relative;
        border-radius: 999px;
        border: 1px solid #30508b;
        background: rgba(148, 163, 184, 0.15);
      }

      .range-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.86), rgba(56, 189, 248, 0.86));
      }

      .range-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 21px;
        background: #fff;
      }

      .range-meta {
        margin-top: 0.35rem;
        display: flex;
        justify-content: space-between;
        font-size: 0.73rem;
        color: var(--muted);
      }

      .news-next {
        border: 1px solid #6b3341;
        background: linear-gradient(180deg, rgba(77, 26, 38, 0.55), rgba(36, 14, 22, 0.9));
      }

      .news-next .label {
        color: #f2becd;
      }

      .news-next .big {
        font-size: clamp(1.02rem, 2.2vw, 1.34rem);
        line-height: 1.2;
      }

      .news-next .delta {
        color: #f6d5dd;
      }

      .panels {
        margin-top: 0.6rem;
        display: grid;
        grid-template-columns: 1.18fr 1fr;
        gap: 0.6rem;
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 0.78rem;
        background: linear-gradient(180deg, rgba(15, 29, 58, 0.96), rgba(10, 20, 43, 0.96));
      }

      .panel-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .panel-head h2,
      .panel-head h3 {
        margin: 0;
        font-size: 1rem;
      }

      .toggle {
        display: inline-flex;
        border: 1px solid #2f4f8b;
        border-radius: 10px;
        overflow: hidden;
      }

      .tbtn {
        border: none;
        border-left: 1px solid #2f4f8b;
        background: #122850;
        color: #9db4df;
        font-family: inherit;
        font-size: 0.73rem;
        text-transform: uppercase;
        font-weight: 700;
        padding: 0.36rem 0.6rem;
        cursor: pointer;
      }

      .tbtn:first-child {
        border-left: none;
      }

      .tbtn.active {
        background: linear-gradient(145deg, #214581, #173463);
        color: #edf3ff;
      }

      #intraday-chart,
      #weekly-chart {
        height: 320px;
        margin-top: 0.45rem;
      }

      .rf-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
        margin-top: 0.6rem;
      }

      .rf-toggle {
        display: inline-flex;
        border: 1px solid #724157;
        border-radius: 10px;
        overflow: hidden;
      }

      .rf-btn {
        border: none;
        border-left: 1px solid #724157;
        background: #451b2a;
        color: #e0b0bd;
        font-family: inherit;
        font-size: 0.72rem;
        text-transform: uppercase;
        font-weight: 700;
        padding: 0.34rem 0.56rem;
        cursor: pointer;
      }

      .rf-btn:first-child {
        border-left: none;
      }

      .rf-btn.active {
        background: linear-gradient(145deg, #7f3047, #602336);
        color: #ffe7ed;
      }

      .rf-strip {
        margin-top: 0.5rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.55rem;
      }

      .rf-card {
        border: 1px solid #704154;
        border-radius: 14px;
        background: linear-gradient(180deg, rgba(82, 29, 44, 0.58), rgba(37, 14, 24, 0.9));
        padding: 0.58rem;
      }

      .rf-time {
        color: #ffd8e2;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.74rem;
      }

      .rf-title {
        margin-top: 0.18rem;
        font-size: 0.82rem;
        line-height: 1.28;
      }

      .cc {
        display: inline-block;
        margin-right: 0.32rem;
        border: 1px solid #8b5467;
        border-radius: 999px;
        padding: 0.08rem 0.35rem;
        background: rgba(112, 65, 84, 0.35);
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.68rem;
        color: #ffe5ec;
      }

      .error {
        margin-top: 0.6rem;
        display: none;
        border: 1px solid #8b3e4e;
        border-radius: 12px;
        padding: 0.65rem 0.78rem;
        background: rgba(139, 62, 78, 0.18);
        color: #ffd3dc;
        font-size: 0.84rem;
      }

      .error.show {
        display: block;
      }

      .mini {
        margin-top: 0.42rem;
        color: var(--muted);
        font-size: 0.74rem;
      }

      footer {
        margin-top: 0.7rem;
        color: #8ca3cb;
        font-size: 0.72rem;
        text-align: center;
      }

      @media (max-width: 1120px) {
        .glance,
        .rf-strip {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .panels {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .top-row {
          grid-template-columns: 1fr;
        }

        .actions {
          justify-content: flex-start;
        }

        .tabs,
        .glance,
        .rf-strip {
          grid-template-columns: 1fr;
        }

        #intraday-chart,
        #weekly-chart {
          height: 255px;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="top">
        <div class="top-row">
          <div>
            <h1>COT Glance Board</h1>
            <p class="sub">One-screen weekly bias + intraday + red-folder risk.</p>
          </div>
          <div class="actions">
            <button class="btn" id="sync-btn">Sync</button>
          </div>
        </div>
        <div class="chip-row">
          <span class="chip" id="chip-generated">Generated --</span>
          <span class="chip" id="chip-report">Report --</span>
          <span class="chip" id="chip-intraday">Intraday --</span>
          <span class="chip" id="chip-next-cot">Next COT --</span>
          <span class="chip" id="chip-last-sync">Last sync --</span>
        </div>

        <div class="tabs" id="market-tabs"></div>

        <div class="alert">
          <b id="setup-title">Setup --</b>
          <span id="setup-text">Waiting for data...</span>
        </div>
      </section>

      <section class="glance">
        <article class="card">
          <p class="label">Weekly Bias</p>
          <p class="big" id="bias-label">--</p>
          <p class="delta mono" id="bias-score">--</p>
          <div class="gauge"><span class="gauge-marker" id="bias-marker"></span></div>
          <p class="mini" id="bias-mini">--</p>
        </article>

        <article class="card">
          <p class="label">Intraday Price</p>
          <p class="big mono" id="price-last">--</p>
          <p class="delta mono" id="price-change">--</p>
          <p class="mini" id="price-state">--</p>
        </article>

        <article class="card">
          <p class="label">Session Range</p>
          <p class="big mono" id="range-pos">--</p>
          <div class="range">
            <span class="range-fill" id="range-fill"></span>
            <span class="range-marker" id="range-marker"></span>
          </div>
          <div class="range-meta">
            <span id="range-low">Low --</span>
            <span id="range-high">High --</span>
          </div>
        </article>

        <article class="card news-next">
          <p class="label">Next Red Folder</p>
          <p class="big" id="next-news-title">--</p>
          <p class="delta" id="next-news-time">--</p>
          <p class="mini" id="next-news-meta">--</p>
        </article>
      </section>

      <div class="error" id="error-box"></div>

      <section class="panels">
        <article class="panel">
          <div class="panel-head">
            <h2 id="intraday-title">Intraday</h2>
          </div>
          <div id="intraday-chart"></div>
        </article>

        <article class="panel">
          <div class="panel-head">
            <h3 id="weekly-title">Weekly Structure</h3>
            <div class="toggle">
              <button class="tbtn" id="mode-trend">Trend</button>
              <button class="tbtn" id="mode-shift">Shift</button>
            </div>
          </div>
          <div id="weekly-chart"></div>
        </article>
      </section>

      <section class="panel">
        <div class="rf-header">
          <h3>Forex Factory Red Folder</h3>
          <div class="rf-toggle">
            <button class="rf-btn" id="rf-usd">USD</button>
            <button class="rf-btn" id="rf-all">All</button>
          </div>
        </div>
        <p class="mini" id="rf-meta">--</p>
        <div class="rf-strip" id="rf-strip"></div>
      </section>

      <footer>
        CFTC + Yahoo + Forex Factory. Keep it simple: bias, price, risk.
      </footer>
    </main>

    <script>
      const MARKET_ORDER = ["dow_jones", "nasdaq_100", "sp_500"];
      const ETF = { dow_jones: "DIA", nasdaq_100: "QQQ", sp_500: "SPY" };

      const state = {
        snapshot: null,
        activeMarket: "dow_jones",
        chartMode: localStorage.getItem("glance_chart_mode") || "trend",
        newsFilter: localStorage.getItem("glance_news_filter") || "usd",
        loading: false,
      };

      const el = {
        syncBtn: document.getElementById("sync-btn"),
        chipGenerated: document.getElementById("chip-generated"),
        chipReport: document.getElementById("chip-report"),
        chipIntraday: document.getElementById("chip-intraday"),
        chipNextCot: document.getElementById("chip-next-cot"),
        chipLastSync: document.getElementById("chip-last-sync"),
        marketTabs: document.getElementById("market-tabs"),
        setupTitle: document.getElementById("setup-title"),
        setupText: document.getElementById("setup-text"),
        biasLabel: document.getElementById("bias-label"),
        biasScore: document.getElementById("bias-score"),
        biasMarker: document.getElementById("bias-marker"),
        biasMini: document.getElementById("bias-mini"),
        priceLast: document.getElementById("price-last"),
        priceChange: document.getElementById("price-change"),
        priceState: document.getElementById("price-state"),
        rangePos: document.getElementById("range-pos"),
        rangeFill: document.getElementById("range-fill"),
        rangeMarker: document.getElementById("range-marker"),
        rangeLow: document.getElementById("range-low"),
        rangeHigh: document.getElementById("range-high"),
        nextNewsTitle: document.getElementById("next-news-title"),
        nextNewsTime: document.getElementById("next-news-time"),
        nextNewsMeta: document.getElementById("next-news-meta"),
        intradayTitle: document.getElementById("intraday-title"),
        weeklyTitle: document.getElementById("weekly-title"),
        modeTrend: document.getElementById("mode-trend"),
        modeShift: document.getElementById("mode-shift"),
        rfUsd: document.getElementById("rf-usd"),
        rfAll: document.getElementById("rf-all"),
        rfMeta: document.getElementById("rf-meta"),
        rfStrip: document.getElementById("rf-strip"),
        error: document.getElementById("error-box"),
      };

      function fmtNum(v, d = 0) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return n.toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
      }

      function fmtSigned(v, d = 0, suffix = "") {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return `${n > 0 ? "+" : ""}${fmtNum(n, d)}${suffix}`;
      }

      function toneClass(v) {
        const n = Number(v);
        if (!Number.isFinite(n) || n === 0) return "flat";
        return n > 0 ? "up" : "down";
      }

      function fmtDate(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      }

      function fmtTime(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function setLoading(flag) {
        state.loading = flag;
        el.syncBtn.disabled = flag;
        el.syncBtn.textContent = flag ? "Syncing..." : "Sync";
      }

      function setChartMode(mode) {
        state.chartMode = mode === "shift" ? "shift" : "trend";
        localStorage.setItem("glance_chart_mode", state.chartMode);
        el.modeTrend.classList.toggle("active", state.chartMode === "trend");
        el.modeShift.classList.toggle("active", state.chartMode === "shift");
      }

      function setNewsFilter(mode) {
        state.newsFilter = mode === "all" ? "all" : "usd";
        localStorage.setItem("glance_news_filter", state.newsFilter);
        el.rfUsd.classList.toggle("active", state.newsFilter === "usd");
        el.rfAll.classList.toggle("active", state.newsFilter === "all");
      }

      function updateNextCotCountdown() {
        const nowNY = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
        const next = new Date(nowNY);
        const dayDiff = (5 - nowNY.getDay() + 7) % 7;
        next.setDate(nowNY.getDate() + dayDiff);
        next.setHours(15, 30, 0, 0);
        if (nowNY.getDay() === 5 && nowNY.getTime() >= next.getTime()) {
          next.setDate(next.getDate() + 7);
        }
        const diff = Math.max(0, next.getTime() - nowNY.getTime());
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        el.chipNextCot.textContent = `Next COT ${d}d ${h}h ${m}m`;
      }

      function buildTabs() {
        const markets = state.snapshot?.markets || {};
        el.marketTabs.innerHTML = "";
        MARKET_ORDER.forEach((key) => {
          const market = markets[key];
          if (!market) return;
          const btn = document.createElement("button");
          btn.className = `tab ${key === state.activeMarket ? "active" : ""}`;
          btn.textContent = market.label;
          btn.addEventListener("click", () => {
            state.activeMarket = key;
            render();
          });
          el.marketTabs.appendChild(btn);
        });
      }

      function getUpcomingNews() {
        const rf = state.snapshot?.news?.red_folder || {};
        const list = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        const filtered = state.newsFilter === "usd" ? list.filter((e) => e.country === "USD") : list;
        return filtered;
      }

      function renderSetup(market) {
        const score = Number(market?.bias?.score || 0);
        const chg = Number(market?.intraday?.change_pct || 0);
        let title = "Balanced";
        let text = "Wait for clean break or rejection. Keep size tight.";

        if (score >= 20) {
          title = "Bullish Week";
          text = "Prefer long setups. Buy dips, avoid shorting random red candles.";
        } else if (score <= -20) {
          title = "Bearish Week";
          text = "Prefer short setups. Sell pops, avoid chasing low-probability longs.";
        }

        if (Math.abs(chg) > 1.2) {
          text += " Volatility expanded today.";
        }

        el.setupTitle.textContent = title;
        el.setupText.textContent = text;
      }

      function renderCards(market) {
        const bias = market?.bias || {};
        const intra = market?.intraday || {};
        const latest = market?.latest || {};

        const score = Number(bias.score || 0);
        const scoreClass = toneClass(score);
        el.biasLabel.textContent = bias.label || "Neutral";
        el.biasScore.className = `delta mono ${scoreClass}`;
        el.biasScore.textContent = `Score ${fmtSigned(score, 1)} | Conviction ${fmtNum(bias.conviction || 0, 0)}%`;
        el.biasMini.textContent = `Asset pct ${fmtNum(bias.asset_percentile || 0, 1)} | Lev pct ${fmtNum(bias.leveraged_percentile || 0, 1)}`;

        const marker = Math.max(0, Math.min(100, ((score + 100) / 200) * 100));
        el.biasMarker.style.left = `${marker}%`;

        const ticker = intra.symbol || ETF[state.activeMarket] || "--";
        el.priceLast.textContent = `${ticker} ${fmtNum(intra.last, 2)}`;
        const pc = Number(intra.change_pct || 0);
        el.priceChange.className = `delta mono ${toneClass(pc)}`;
        el.priceChange.textContent = `${fmtSigned(intra.change, 2)} (${fmtSigned(pc, 2, "%")})`;
        el.priceState.textContent = intra.market_state ? `State ${intra.market_state}` : "State --";

        const rp = Math.max(0, Math.min(100, Number(intra.range_position_pct || 0)));
        el.rangePos.textContent = `${fmtNum(rp, 1)}%`;
        el.rangeFill.style.width = `${rp}%`;
        el.rangeMarker.style.left = `${rp}%`;
        el.rangeLow.textContent = `Low ${fmtNum(intra.day_low, 2)}`;
        el.rangeHigh.textContent = `High ${fmtNum(intra.day_high, 2)}`;

        const news = getUpcomingNews();
        const next = news[0];
        if (next) {
          el.nextNewsTitle.textContent = `${next.country || "--"} ${next.title || "Event"}`;
          el.nextNewsTime.textContent = fmtTime(next.datetime_utc || `${next.date} ${next.time}`);
          el.nextNewsMeta.textContent = `${news.length} upcoming (${state.newsFilter.toUpperCase()})`;
        } else {
          el.nextNewsTitle.textContent = "No upcoming red-folder";
          el.nextNewsTime.textContent = "--";
          el.nextNewsMeta.textContent = "No event risk in filter";
        }

        el.chipReport.textContent = `Report ${fmtDate(market.latest_report_date)} (${market.contract_code})`;
        el.chipIntraday.textContent = `Intraday ${fmtTime(intra.as_of_utc || state.snapshot.generated_at_utc)}`;
      }

      function renderIntradayChart(market) {
        const intra = market?.intraday || {};
        const bars = Array.isArray(intra.bars) ? intra.bars : [];
        if (bars.length < 2 || intra.error) {
          Plotly.react(
            "intraday-chart",
            [],
            {
              margin: { l: 30, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(10,20,44,0.85)",
              font: { family: "Sora, sans-serif", color: "#d7e6ff" },
              annotations: [
                { text: "No intraday bars", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false },
              ],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = bars.map((b) => b.t);
        const y = bars.map((b) => b.c);
        const bullish = Number(intra.change_pct || 0) >= 0;
        const color = bullish ? "#22c55e" : "#ef4444";

        Plotly.react(
          "intraday-chart",
          [
            {
              type: "scatter",
              mode: "lines",
              x,
              y,
              line: { color, width: 3 },
              fill: "tozeroy",
              fillcolor: bullish ? "rgba(34,197,94,0.18)" : "rgba(239,68,68,0.18)",
              hovertemplate: "%{x}<br>%{y:.2f}<extra></extra>",
            },
          ],
          {
            margin: { l: 42, r: 12, t: 8, b: 28 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(10,20,44,0.85)",
            font: { family: "Sora, sans-serif", color: "#d7e6ff" },
            hovermode: "x unified",
            xaxis: { type: "date", tickformat: "%H:%M", gridcolor: "rgba(120,150,205,0.16)" },
            yaxis: { gridcolor: "rgba(120,150,205,0.2)", zeroline: false },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderWeeklyChart(market) {
        const history = Array.isArray(market.history) ? market.history : [];
        if (history.length < 2) {
          Plotly.react(
            "weekly-chart",
            [],
            {
              margin: { l: 30, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(10,20,44,0.85)",
              annotations: [
                { text: "No weekly rows", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false },
              ],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        if (state.chartMode === "shift") {
          const latest = history[history.length - 1];
          const prev = history[history.length - 2];
          const labels = ["Asset", "Leveraged", "OI"];
          const vals = [
            Number(latest.asset_mgr_net || 0) - Number(prev.asset_mgr_net || 0),
            Number(latest.leveraged_net || 0) - Number(prev.leveraged_net || 0),
            Number(latest.open_interest || 0) - Number(prev.open_interest || 0),
          ];
          const colors = vals.map((v) => (v >= 0 ? "rgba(34,197,94,0.9)" : "rgba(239,68,68,0.9)"));

          Plotly.react(
            "weekly-chart",
            [
              {
                type: "bar",
                x: labels,
                y: vals,
                marker: { color: colors, line: { color: "rgba(8,14,30,1)", width: 1 } },
                text: vals.map((v) => fmtSigned(v)),
                textposition: "outside",
                hovertemplate: "%{x} Δ %{y:,}<extra></extra>",
              },
            ],
            {
              margin: { l: 42, r: 12, t: 20, b: 36 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(10,20,44,0.85)",
              font: { family: "Sora, sans-serif", color: "#d7e6ff" },
              yaxis: { gridcolor: "rgba(120,150,205,0.2)", zerolinecolor: "rgba(150,170,220,0.45)" },
              annotations: [
                {
                  text: `${fmtDate(prev.report_date)} → ${fmtDate(latest.report_date)}`,
                  x: 0,
                  y: 1.14,
                  xref: "paper",
                  yref: "paper",
                  showarrow: false,
                  font: { size: 11, color: "#9db4df" },
                },
              ],
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = history.map((h) => h.report_date);
        const asset = history.map((h) => h.asset_mgr_net);
        const lev = history.map((h) => h.leveraged_net);

        Plotly.react(
          "weekly-chart",
          [
            { type: "scatter", mode: "lines", x, y: asset, name: "Asset", line: { color: "#f59e0b", width: 3 } },
            { type: "scatter", mode: "lines", x, y: lev, name: "Leveraged", line: { color: "#38bdf8", width: 3 } },
          ],
          {
            margin: { l: 42, r: 12, t: 10, b: 30 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(10,20,44,0.85)",
            font: { family: "Sora, sans-serif", color: "#d7e6ff" },
            hovermode: "x unified",
            legend: { orientation: "h", y: 1.12, x: 0 },
            xaxis: { type: "date", tickformat: "%b %Y", gridcolor: "rgba(120,150,205,0.16)" },
            yaxis: { gridcolor: "rgba(120,150,205,0.2)", zerolinecolor: "rgba(150,170,220,0.45)" },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderNewsStrip() {
        const rf = state.snapshot?.news?.red_folder || {};
        const all = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        const list = state.newsFilter === "usd" ? all.filter((e) => e.country === "USD") : all;
        const show = list.slice(0, 8);

        const fetched = rf.fetched_at_utc ? fmtTime(rf.fetched_at_utc) : "--";
        el.rfMeta.textContent = `${list.length} events • filter ${state.newsFilter.toUpperCase()} • feed ${fetched}`;

        if (!show.length) {
          el.rfStrip.innerHTML = `<div class="rf-card"><div class="rf-title">No high-impact events in this filter.</div></div>`;
          return;
        }

        el.rfStrip.innerHTML = show
          .map((e) => {
            const t = e.datetime_utc ? fmtTime(e.datetime_utc) : `${e.date || "--"} ${e.time || "--"}`;
            return `
              <article class="rf-card">
                <div class="rf-time">${t}</div>
                <div class="rf-title"><span class="cc">${e.country || "--"}</span>${e.title || "Event"}</div>
              </article>
            `;
          })
          .join("");
      }

      function renderHeader(market) {
        el.chipGenerated.textContent = `Generated ${fmtTime(state.snapshot.generated_at_utc)}`;
        const last = localStorage.getItem("glance_last_sync") || "--";
        el.chipLastSync.textContent = `Last sync ${last}`;
        el.intradayTitle.textContent = `${market.label} Intraday (${market.intraday?.symbol || ETF[state.activeMarket] || "--"})`;
        el.weeklyTitle.textContent = state.chartMode === "trend" ? "Weekly Trend" : "Weekly Shift";
      }

      function render() {
        if (!state.snapshot?.markets) return;
        const market = state.snapshot.markets[state.activeMarket];
        if (!market) return;

        buildTabs();
        renderHeader(market);
        renderSetup(market);
        renderCards(market);
        renderIntradayChart(market);
        renderWeeklyChart(market);
        renderNewsStrip();
      }

      async function loadSnapshot(manual = false) {
        setLoading(true);
        try {
          const res = await fetch(`./data/cot_snapshot.json?ts=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          if (!payload?.markets) throw new Error("Bad snapshot");
          state.snapshot = payload;
          if (!payload.markets[state.activeMarket]) {
            state.activeMarket = Object.keys(payload.markets)[0];
          }
          el.error.classList.remove("show");
          if (manual || !localStorage.getItem("glance_last_sync")) {
            const now = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            localStorage.setItem("glance_last_sync", now);
          }
          render();
        } catch (e) {
          el.error.textContent = `Failed to load data: ${e.message}`;
          el.error.classList.add("show");
        } finally {
          setLoading(false);
        }
      }

      el.syncBtn.addEventListener("click", () => loadSnapshot(true));
      el.modeTrend.addEventListener("click", () => {
        setChartMode("trend");
        if (state.snapshot) render();
      });
      el.modeShift.addEventListener("click", () => {
        setChartMode("shift");
        if (state.snapshot) render();
      });
      el.rfUsd.addEventListener("click", () => {
        setNewsFilter("usd");
        if (state.snapshot) render();
      });
      el.rfAll.addEventListener("click", () => {
        setNewsFilter("all");
        if (state.snapshot) render();
      });

      setChartMode(state.chartMode);
      setNewsFilter(state.newsFilter);
      updateNextCotCountdown();
      setInterval(updateNextCotCountdown, 30000);
      loadSnapshot();
    </script>
  </body>
</html>
