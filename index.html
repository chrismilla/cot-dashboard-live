<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COT Aura Board</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Sora:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      :root {
        --bg-0: #050b18;
        --bg-1: #081631;
        --bg-2: #112a58;
        --panel: rgba(12, 26, 54, 0.78);
        --panel-strong: rgba(14, 30, 62, 0.92);
        --line: rgba(121, 159, 227, 0.28);
        --line-strong: rgba(151, 188, 255, 0.42);
        --text: #f1f5ff;
        --muted: #a4badf;
        --bull: #22c55e;
        --bear: #ef4444;
        --neutral: #9ca3af;
        --hot: #ff7a2f;
        --pink: #f472b6;
        --gold: #fbbf24;
        --cyan: #38bdf8;
        --shadow: 0 26px 70px rgba(2, 7, 19, 0.52);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: "Sora", sans-serif;
        background:
          radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.28), transparent 34%),
          radial-gradient(circle at 100% 0%, rgba(255, 122, 47, 0.24), transparent 30%),
          radial-gradient(circle at 50% 100%, rgba(244, 114, 182, 0.12), transparent 38%),
          linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 55%, var(--bg-2) 100%);
        min-height: 100vh;
      }

      body::before,
      body::after {
        content: "";
        position: fixed;
        z-index: -1;
        width: 34vw;
        height: 34vw;
        border-radius: 999px;
        filter: blur(82px);
        opacity: 0.4;
        pointer-events: none;
      }

      body::before {
        left: -10vw;
        top: 12vh;
        background: rgba(56, 189, 248, 0.38);
      }

      body::after {
        right: -8vw;
        top: 18vh;
        background: rgba(255, 122, 47, 0.34);
      }

      .shell {
        width: min(1340px, calc(100% - 1rem));
        margin: 0 auto;
        padding: 0.95rem 0 1.3rem;
      }

      .hero {
        position: relative;
        overflow: hidden;
        border-radius: 28px;
        border: 1px solid var(--line-strong);
        background:
          linear-gradient(140deg, rgba(18, 38, 78, 0.88), rgba(8, 19, 41, 0.9)),
          radial-gradient(circle at 85% 10%, rgba(255, 122, 47, 0.24), transparent 40%),
          radial-gradient(circle at 10% 90%, rgba(56, 189, 248, 0.2), transparent 42%);
        box-shadow: var(--shadow);
        padding: 1rem;
      }

      .hero-grid {
        display: grid;
        grid-template-columns: 1.45fr auto;
        gap: 0.95rem;
        align-items: start;
      }

      .eyebrow {
        margin: 0;
        color: #bad0f5;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        font-weight: 700;
      }

      h1 {
        margin: 0.22rem 0 0;
        font-size: clamp(1.35rem, 3.9vw, 2.55rem);
        line-height: 1.04;
        letter-spacing: -0.02em;
      }

      .hero-sub {
        margin: 0.36rem 0 0;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .setup {
        margin-top: 0.72rem;
        border: 1px solid rgba(134, 171, 235, 0.36);
        border-radius: 14px;
        padding: 0.58rem 0.72rem;
        background: rgba(11, 24, 48, 0.75);
      }

      .setup b {
        font-size: 0.95rem;
      }

      .setup span {
        display: block;
        margin-top: 0.12rem;
        color: #d8e4fb;
        font-size: 0.82rem;
      }

      .chips {
        margin-top: 0.65rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.42rem;
      }

      .chip {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 0.28rem 0.58rem;
        background: rgba(9, 20, 43, 0.72);
        color: var(--muted);
        font-size: 0.73rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .hero-right {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-end;
      }

      .sync-btn {
        border: 1px solid #4570b5;
        border-radius: 999px;
        background: linear-gradient(145deg, #27519a, #1a3f7a);
        color: #eef5ff;
        font-family: inherit;
        font-weight: 700;
        font-size: 0.79rem;
        padding: 0.45rem 0.88rem;
        cursor: pointer;
      }

      .sync-btn:disabled {
        opacity: 0.72;
        cursor: wait;
      }

      .bias-pill {
        border: 1px solid rgba(151, 188, 255, 0.4);
        border-radius: 14px;
        padding: 0.56rem 0.72rem;
        min-width: 214px;
        text-align: right;
        background: rgba(11, 24, 48, 0.82);
      }

      .bias-pill .k {
        margin: 0;
        color: #bcd2f8;
        font-size: 0.64rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .bias-pill .v {
        margin: 0.1rem 0 0;
        font-size: 1.25rem;
        font-weight: 800;
      }

      .bias-pill .m {
        margin: 0.2rem 0 0;
        color: var(--muted);
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.74rem;
      }

      .tabs {
        margin-top: 0.78rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.46rem;
      }

      .tab {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 0.66rem;
        background: rgba(13, 29, 59, 0.82);
        color: #b3c8ef;
        font-family: inherit;
        font-size: 0.83rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        cursor: pointer;
        transition: 120ms ease;
      }

      .tab:hover {
        transform: translateY(-1px);
      }

      .tab.active {
        border-color: #85b1f1;
        color: #f3f8ff;
        background: linear-gradient(145deg, rgba(42, 82, 154, 0.9), rgba(24, 55, 104, 0.88));
        box-shadow: 0 10px 24px rgba(9, 21, 43, 0.42);
      }

      .grid-kpi {
        margin-top: 0.66rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.56rem;
      }

      .kpi {
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 0.78rem;
        background: linear-gradient(180deg, rgba(13, 28, 58, 0.9), rgba(10, 21, 45, 0.88));
        box-shadow: inset 0 0 0 1px rgba(111, 145, 207, 0.08);
        min-height: 152px;
      }

      .kpi.news {
        border-color: rgba(171, 85, 109, 0.46);
        background: linear-gradient(180deg, rgba(72, 24, 38, 0.58), rgba(35, 12, 22, 0.9));
      }

      .kpi .label {
        margin: 0;
        color: var(--muted);
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .kpi.news .label {
        color: #f1bdcc;
      }

      .kpi .big {
        margin: 0.34rem 0 0;
        font-size: clamp(1.35rem, 2.8vw, 2.08rem);
        line-height: 1;
        font-weight: 800;
      }

      .kpi .sub {
        margin: 0.24rem 0 0;
        color: var(--muted);
        font-size: 0.74rem;
      }

      .mono {
        font-family: "IBM Plex Mono", monospace;
      }

      .delta {
        margin-top: 0.24rem;
        font-size: 0.8rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .up {
        color: var(--bull);
      }

      .down {
        color: var(--bear);
      }

      .flat {
        color: var(--neutral);
      }

      .gauge {
        margin-top: 0.58rem;
        height: 18px;
        position: relative;
        border-radius: 999px;
        border: 1px solid #335797;
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.48), rgba(148, 163, 184, 0.2), rgba(34, 197, 94, 0.48));
      }

      .gauge-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 22px;
        background: #fff;
        box-shadow: 0 0 12px rgba(255, 255, 255, 0.95);
      }

      .range {
        margin-top: 0.62rem;
        height: 16px;
        position: relative;
        border-radius: 999px;
        border: 1px solid #335797;
        background: rgba(148, 163, 184, 0.16);
      }

      .range-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.9), rgba(56, 189, 248, 0.9));
      }

      .range-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 21px;
        background: #fff;
      }

      .range-meta {
        margin-top: 0.3rem;
        display: flex;
        justify-content: space-between;
        color: var(--muted);
        font-size: 0.71rem;
      }

      .panels {
        margin-top: 0.56rem;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 0.56rem;
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 0.72rem;
        background: linear-gradient(180deg, rgba(13, 28, 58, 0.9), rgba(10, 21, 45, 0.88));
      }

      .panel-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.4rem;
        flex-wrap: wrap;
      }

      .panel-head h2,
      .panel-head h3 {
        margin: 0;
        font-size: 0.98rem;
      }

      .toggle {
        display: inline-flex;
        border: 1px solid #355a9b;
        border-radius: 10px;
        overflow: hidden;
      }

      .tbtn {
        border: none;
        border-left: 1px solid #355a9b;
        background: rgba(15, 32, 67, 0.86);
        color: #a5bce3;
        font-family: inherit;
        font-size: 0.71rem;
        text-transform: uppercase;
        font-weight: 700;
        padding: 0.34rem 0.56rem;
        cursor: pointer;
      }

      .tbtn:first-child {
        border-left: none;
      }

      .tbtn.active {
        background: linear-gradient(145deg, rgba(45, 88, 167, 0.9), rgba(26, 58, 112, 0.9));
        color: #f1f6ff;
      }

      #intraday-chart,
      #weekly-chart {
        height: 325px;
        margin-top: 0.4rem;
      }

      .news-board {
        margin-top: 0.56rem;
        border: 1px solid rgba(166, 78, 103, 0.48);
        border-radius: 20px;
        padding: 0.72rem;
        background: linear-gradient(180deg, rgba(67, 22, 35, 0.56), rgba(30, 11, 19, 0.9));
      }

      .news-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.48rem;
        flex-wrap: wrap;
      }

      .news-head h3 {
        margin: 0;
        font-size: 0.98rem;
      }

      .rf-toggle {
        display: inline-flex;
        border: 1px solid #8b4a63;
        border-radius: 10px;
        overflow: hidden;
      }

      .rf-btn {
        border: none;
        border-left: 1px solid #8b4a63;
        background: rgba(65, 24, 37, 0.84);
        color: #e0b0bf;
        font-family: inherit;
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 700;
        padding: 0.32rem 0.52rem;
        cursor: pointer;
      }

      .rf-btn:first-child {
        border-left: none;
      }

      .rf-btn.active {
        background: linear-gradient(145deg, rgba(136, 49, 74, 0.9), rgba(95, 33, 50, 0.9));
        color: #ffe6ed;
      }

      .news-meta {
        margin: 0.35rem 0 0;
        color: #e2b9c5;
        font-size: 0.73rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .rf-grid {
        margin-top: 0.46rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.46rem;
      }

      .rf-card {
        border: 1px solid rgba(148, 72, 95, 0.62);
        border-radius: 14px;
        padding: 0.56rem;
        background: linear-gradient(180deg, rgba(84, 31, 47, 0.62), rgba(45, 15, 27, 0.9));
      }

      .rf-time {
        color: #ffd7e2;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.73rem;
      }

      .rf-title {
        margin-top: 0.18rem;
        line-height: 1.28;
        font-size: 0.81rem;
      }

      .cc {
        display: inline-block;
        margin-right: 0.3rem;
        border: 1px solid #97617a;
        border-radius: 999px;
        padding: 0.08rem 0.35rem;
        background: rgba(118, 59, 79, 0.38);
        color: #ffe7ee;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.66rem;
      }

      .error {
        margin-top: 0.56rem;
        border: 1px solid rgba(179, 69, 89, 0.66);
        border-radius: 12px;
        padding: 0.65rem 0.78rem;
        background: rgba(179, 69, 89, 0.18);
        color: #ffd2dd;
        font-size: 0.82rem;
        display: none;
      }

      .error.show {
        display: block;
      }

      footer {
        margin-top: 0.62rem;
        text-align: center;
        color: #90a8d1;
        font-size: 0.71rem;
      }

      @media (max-width: 1160px) {
        .grid-kpi,
        .rf-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .panels {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .hero-grid {
          grid-template-columns: 1fr;
        }

        .hero-right {
          align-items: flex-start;
        }

        .tabs,
        .grid-kpi,
        .rf-grid {
          grid-template-columns: 1fr;
        }

        #intraday-chart,
        #weekly-chart {
          height: 252px;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="hero">
        <div class="hero-grid">
          <div>
            <p class="eyebrow">COT Aura</p>
            <h1 id="hero-market">Loading...</h1>
            <p class="hero-sub">Beautiful, glanceable trading board.</p>
            <div class="setup">
              <b id="setup-title">Setup --</b>
              <span id="setup-text">Waiting for data...</span>
            </div>
            <div class="chips">
              <span class="chip" id="chip-generated">Generated --</span>
              <span class="chip" id="chip-report">Report --</span>
              <span class="chip" id="chip-intraday">Intraday --</span>
              <span class="chip" id="chip-next-cot">Next COT --</span>
              <span class="chip" id="chip-last-sync">Last sync --</span>
            </div>
          </div>
          <div class="hero-right">
            <button class="sync-btn" id="sync-btn">Sync</button>
            <div class="bias-pill">
              <p class="k">Weekly Bias</p>
              <p class="v" id="hero-bias">--</p>
              <p class="m" id="hero-bias-meta">--</p>
            </div>
          </div>
        </div>

        <div class="tabs" id="market-tabs"></div>
      </section>

      <section class="grid-kpi">
        <article class="kpi">
          <p class="label">Bias Gauge</p>
          <p class="big" id="bias-label">--</p>
          <p class="delta mono" id="bias-score">--</p>
          <div class="gauge"><span class="gauge-marker" id="bias-marker"></span></div>
          <p class="sub" id="bias-mini">--</p>
        </article>

        <article class="kpi">
          <p class="label">Intraday Price</p>
          <p class="big mono" id="price-last">--</p>
          <p class="delta mono" id="price-change">--</p>
          <p class="sub" id="price-state">--</p>
        </article>

        <article class="kpi">
          <p class="label">Session Range</p>
          <p class="big mono" id="range-pos">--</p>
          <div class="range">
            <span class="range-fill" id="range-fill"></span>
            <span class="range-marker" id="range-marker"></span>
          </div>
          <div class="range-meta">
            <span id="range-low">Low --</span>
            <span id="range-high">High --</span>
          </div>
        </article>

        <article class="kpi news">
          <p class="label">Next Red Folder</p>
          <p class="big" id="next-news-title">--</p>
          <p class="delta" id="next-news-time">--</p>
          <p class="sub" id="next-news-meta">--</p>
        </article>
      </section>

      <section class="panels">
        <article class="panel">
          <div class="panel-head">
            <h2 id="intraday-title">Intraday</h2>
          </div>
          <div id="intraday-chart"></div>
        </article>

        <article class="panel">
          <div class="panel-head">
            <h3 id="weekly-title">Weekly Trend</h3>
            <div class="toggle">
              <button class="tbtn" id="mode-trend">Trend</button>
              <button class="tbtn" id="mode-shift">Shift</button>
            </div>
          </div>
          <div id="weekly-chart"></div>
        </article>
      </section>

      <section class="news-board">
        <div class="news-head">
          <h3>Forex Factory Red Folder</h3>
          <div class="rf-toggle">
            <button class="rf-btn" id="rf-usd">USD</button>
            <button class="rf-btn" id="rf-all">All</button>
          </div>
        </div>
        <p class="news-meta" id="rf-meta">--</p>
        <div class="rf-grid" id="rf-strip"></div>
      </section>

      <div class="error" id="error-box"></div>

      <footer>
        CFTC + Yahoo + Forex Factory. Bias, price, event risk.
      </footer>
    </main>

    <script>
      const MARKET_ORDER = ["dow_jones", "nasdaq_100", "sp_500"];
      const ETF = { dow_jones: "DIA", nasdaq_100: "QQQ", sp_500: "SPY" };

      const state = {
        snapshot: null,
        activeMarket: "dow_jones",
        chartMode: localStorage.getItem("aura_chart_mode") || "trend",
        newsFilter: localStorage.getItem("aura_news_filter") || "usd",
        loading: false,
      };

      const el = {
        syncBtn: document.getElementById("sync-btn"),
        heroMarket: document.getElementById("hero-market"),
        heroBias: document.getElementById("hero-bias"),
        heroBiasMeta: document.getElementById("hero-bias-meta"),
        setupTitle: document.getElementById("setup-title"),
        setupText: document.getElementById("setup-text"),
        chipGenerated: document.getElementById("chip-generated"),
        chipReport: document.getElementById("chip-report"),
        chipIntraday: document.getElementById("chip-intraday"),
        chipNextCot: document.getElementById("chip-next-cot"),
        chipLastSync: document.getElementById("chip-last-sync"),
        marketTabs: document.getElementById("market-tabs"),
        biasLabel: document.getElementById("bias-label"),
        biasScore: document.getElementById("bias-score"),
        biasMarker: document.getElementById("bias-marker"),
        biasMini: document.getElementById("bias-mini"),
        priceLast: document.getElementById("price-last"),
        priceChange: document.getElementById("price-change"),
        priceState: document.getElementById("price-state"),
        rangePos: document.getElementById("range-pos"),
        rangeFill: document.getElementById("range-fill"),
        rangeMarker: document.getElementById("range-marker"),
        rangeLow: document.getElementById("range-low"),
        rangeHigh: document.getElementById("range-high"),
        nextNewsTitle: document.getElementById("next-news-title"),
        nextNewsTime: document.getElementById("next-news-time"),
        nextNewsMeta: document.getElementById("next-news-meta"),
        intradayTitle: document.getElementById("intraday-title"),
        weeklyTitle: document.getElementById("weekly-title"),
        modeTrend: document.getElementById("mode-trend"),
        modeShift: document.getElementById("mode-shift"),
        rfUsd: document.getElementById("rf-usd"),
        rfAll: document.getElementById("rf-all"),
        rfMeta: document.getElementById("rf-meta"),
        rfStrip: document.getElementById("rf-strip"),
        error: document.getElementById("error-box"),
      };

      function fmtNum(v, d = 0) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return n.toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
      }

      function fmtSigned(v, d = 0, suffix = "") {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return `${n > 0 ? "+" : ""}${fmtNum(n, d)}${suffix}`;
      }

      function toneClass(v) {
        const n = Number(v);
        if (!Number.isFinite(n) || n === 0) return "flat";
        return n > 0 ? "up" : "down";
      }

      function fmtDate(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      }

      function fmtTime(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function setLoading(flag) {
        state.loading = flag;
        el.syncBtn.disabled = flag;
        el.syncBtn.textContent = flag ? "Syncing..." : "Sync";
      }

      function setChartMode(mode) {
        state.chartMode = mode === "shift" ? "shift" : "trend";
        localStorage.setItem("aura_chart_mode", state.chartMode);
        el.modeTrend.classList.toggle("active", state.chartMode === "trend");
        el.modeShift.classList.toggle("active", state.chartMode === "shift");
      }

      function setNewsFilter(mode) {
        state.newsFilter = mode === "all" ? "all" : "usd";
        localStorage.setItem("aura_news_filter", state.newsFilter);
        el.rfUsd.classList.toggle("active", state.newsFilter === "usd");
        el.rfAll.classList.toggle("active", state.newsFilter === "all");
      }

      function updateNextCotCountdown() {
        const nowNY = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
        const next = new Date(nowNY);
        const dayDiff = (5 - nowNY.getDay() + 7) % 7;
        next.setDate(nowNY.getDate() + dayDiff);
        next.setHours(15, 30, 0, 0);
        if (nowNY.getDay() === 5 && nowNY.getTime() >= next.getTime()) {
          next.setDate(next.getDate() + 7);
        }
        const diff = Math.max(0, next.getTime() - nowNY.getTime());
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        el.chipNextCot.textContent = `Next COT ${d}d ${h}h ${m}m`;
      }

      function buildTabs() {
        const markets = state.snapshot?.markets || {};
        el.marketTabs.innerHTML = "";
        MARKET_ORDER.forEach((key) => {
          const market = markets[key];
          if (!market) return;
          const btn = document.createElement("button");
          btn.className = `tab ${key === state.activeMarket ? "active" : ""}`;
          btn.textContent = market.label;
          btn.addEventListener("click", () => {
            state.activeMarket = key;
            render();
          });
          el.marketTabs.appendChild(btn);
        });
      }

      function getUpcomingNews() {
        const rf = state.snapshot?.news?.red_folder || {};
        const all = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        return state.newsFilter === "usd" ? all.filter((e) => e.country === "USD") : all;
      }

      function renderSetup(market) {
        const score = Number(market?.bias?.score || 0);
        const chg = Number(market?.intraday?.change_pct || 0);
        let title = "Neutral Zone";
        let text = "Wait for clean level reaction before pressing size.";

        if (score >= 20) {
          title = "Bullish Week";
          text = "Lean long. Buy pullbacks and avoid impulsive short fades.";
        } else if (score <= -20) {
          title = "Bearish Week";
          text = "Lean short. Fade pops and avoid weak countertrend longs.";
        }

        if (Math.abs(chg) > 1.2) {
          text += " Volatility elevated.";
        }

        el.setupTitle.textContent = title;
        el.setupText.textContent = text;
      }

      function renderCards(market) {
        const bias = market?.bias || {};
        const intra = market?.intraday || {};

        const score = Number(bias.score || 0);
        el.biasLabel.textContent = bias.label || "Neutral";
        el.biasScore.className = `delta mono ${toneClass(score)}`;
        el.biasScore.textContent = `Score ${fmtSigned(score, 1)} | Conv ${fmtNum(bias.conviction || 0, 0)}%`;
        el.biasMini.textContent = `Asset pct ${fmtNum(bias.asset_percentile || 0, 1)} | Lev pct ${fmtNum(bias.leveraged_percentile || 0, 1)}`;
        el.biasMarker.style.left = `${Math.max(0, Math.min(100, (score + 100) / 2))}%`;

        const ticker = intra.symbol || ETF[state.activeMarket] || "--";
        const changePct = Number(intra.change_pct || 0);
        el.priceLast.textContent = `${ticker} ${fmtNum(intra.last, 2)}`;
        el.priceChange.className = `delta mono ${toneClass(changePct)}`;
        el.priceChange.textContent = `${fmtSigned(intra.change, 2)} (${fmtSigned(changePct, 2, "%")})`;
        el.priceState.textContent = intra.market_state ? `State ${intra.market_state}` : "State --";

        const rp = Math.max(0, Math.min(100, Number(intra.range_position_pct || 0)));
        el.rangePos.textContent = `${fmtNum(rp, 1)}%`;
        el.rangeFill.style.width = `${rp}%`;
        el.rangeMarker.style.left = `${rp}%`;
        el.rangeLow.textContent = `Low ${fmtNum(intra.day_low, 2)}`;
        el.rangeHigh.textContent = `High ${fmtNum(intra.day_high, 2)}`;

        const news = getUpcomingNews();
        const next = news[0];
        if (next) {
          el.nextNewsTitle.textContent = `${next.country || "--"} ${next.title || "Event"}`;
          el.nextNewsTime.textContent = fmtTime(next.datetime_utc || `${next.date} ${next.time}`);
          el.nextNewsMeta.textContent = `${news.length} upcoming ${state.newsFilter.toUpperCase()}`;
        } else {
          el.nextNewsTitle.textContent = "No upcoming red-folder";
          el.nextNewsTime.textContent = "--";
          el.nextNewsMeta.textContent = "No event risk in filter";
        }
      }

      function renderIntradayChart(market) {
        const intra = market?.intraday || {};
        const bars = Array.isArray(intra.bars) ? intra.bars : [];
        if (bars.length < 2 || intra.error) {
          Plotly.react(
            "intraday-chart",
            [],
            {
              margin: { l: 30, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(9,18,39,0.82)",
              font: { family: "Sora, sans-serif", color: "#d7e6ff" },
              annotations: [{ text: "No intraday bars", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false }],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = bars.map((b) => b.t);
        const y = bars.map((b) => b.c);
        const bullish = Number(intra.change_pct || 0) >= 0;
        const color = bullish ? "#22c55e" : "#ef4444";

        Plotly.react(
          "intraday-chart",
          [
            {
              type: "scatter",
              mode: "lines",
              x,
              y,
              line: { color, width: 3.2 },
              fill: "tozeroy",
              fillcolor: bullish ? "rgba(34,197,94,0.2)" : "rgba(239,68,68,0.2)",
              hovertemplate: "%{x}<br>%{y:.2f}<extra></extra>",
            },
          ],
          {
            margin: { l: 44, r: 12, t: 8, b: 30 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(9,18,39,0.82)",
            font: { family: "Sora, sans-serif", color: "#d7e6ff" },
            hovermode: "x unified",
            xaxis: { type: "date", tickformat: "%H:%M", gridcolor: "rgba(120,150,205,0.17)" },
            yaxis: { gridcolor: "rgba(120,150,205,0.22)", zeroline: false },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderWeeklyChart(market) {
        const history = Array.isArray(market.history) ? market.history : [];
        if (history.length < 2) {
          Plotly.react(
            "weekly-chart",
            [],
            {
              margin: { l: 30, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(9,18,39,0.82)",
              annotations: [{ text: "No weekly rows", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false }],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        if (state.chartMode === "shift") {
          const latest = history[history.length - 1];
          const prev = history[history.length - 2];
          const labels = ["Asset", "Leveraged", "OI"];
          const vals = [
            Number(latest.asset_mgr_net || 0) - Number(prev.asset_mgr_net || 0),
            Number(latest.leveraged_net || 0) - Number(prev.leveraged_net || 0),
            Number(latest.open_interest || 0) - Number(prev.open_interest || 0),
          ];
          const colors = vals.map((v) => (v >= 0 ? "rgba(34,197,94,0.92)" : "rgba(239,68,68,0.92)"));

          Plotly.react(
            "weekly-chart",
            [
              {
                type: "bar",
                x: labels,
                y: vals,
                marker: { color: colors, line: { color: "rgba(7,12,24,1)", width: 1 } },
                text: vals.map((v) => fmtSigned(v)),
                textposition: "outside",
                hovertemplate: "%{x} Δ %{y:,}<extra></extra>",
              },
            ],
            {
              margin: { l: 42, r: 12, t: 20, b: 36 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(9,18,39,0.82)",
              font: { family: "Sora, sans-serif", color: "#d7e6ff" },
              yaxis: { gridcolor: "rgba(120,150,205,0.22)", zerolinecolor: "rgba(150,170,220,0.45)" },
              annotations: [{ text: `${fmtDate(prev.report_date)} → ${fmtDate(latest.report_date)}`, x: 0, y: 1.14, xref: "paper", yref: "paper", showarrow: false, font: { size: 11, color: "#9db4df" } }],
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = history.map((h) => h.report_date);
        const asset = history.map((h) => h.asset_mgr_net);
        const lev = history.map((h) => h.leveraged_net);

        Plotly.react(
          "weekly-chart",
          [
            { type: "scatter", mode: "lines", x, y: asset, name: "Asset", line: { color: "#fbbf24", width: 3.2 } },
            { type: "scatter", mode: "lines", x, y: lev, name: "Leveraged", line: { color: "#38bdf8", width: 3.2 } },
          ],
          {
            margin: { l: 42, r: 12, t: 10, b: 30 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(9,18,39,0.82)",
            font: { family: "Sora, sans-serif", color: "#d7e6ff" },
            hovermode: "x unified",
            legend: { orientation: "h", y: 1.12, x: 0 },
            xaxis: { type: "date", tickformat: "%b %Y", gridcolor: "rgba(120,150,205,0.17)" },
            yaxis: { gridcolor: "rgba(120,150,205,0.22)", zerolinecolor: "rgba(150,170,220,0.45)" },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderNewsStrip() {
        const rf = state.snapshot?.news?.red_folder || {};
        const all = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        const list = state.newsFilter === "usd" ? all.filter((e) => e.country === "USD") : all;
        const show = list.slice(0, 8);

        const fetched = rf.fetched_at_utc ? fmtTime(rf.fetched_at_utc) : "--";
        el.rfMeta.textContent = `${list.length} events | ${state.newsFilter.toUpperCase()} | feed ${fetched}`;

        if (!show.length) {
          el.rfStrip.innerHTML = `<div class="rf-card"><div class="rf-title">No high-impact events in this filter.</div></div>`;
          return;
        }

        el.rfStrip.innerHTML = show
          .map((e) => {
            const t = e.datetime_utc ? fmtTime(e.datetime_utc) : `${e.date || "--"} ${e.time || "--"}`;
            return `<article class="rf-card"><div class="rf-time">${t}</div><div class="rf-title"><span class="cc">${e.country || "--"}</span>${e.title || "Event"}</div></article>`;
          })
          .join("");
      }

      function renderHeader(market) {
        const intra = market?.intraday || {};
        const score = Number(market?.bias?.score || 0);

        el.heroMarket.textContent = `${market.label} • ${intra.symbol || ETF[state.activeMarket] || "--"}`;
        el.heroBias.textContent = market?.bias?.label || "Neutral";
        el.heroBias.className = `v ${toneClass(score)}`;
        el.heroBiasMeta.textContent = `Score ${fmtSigned(score, 1)} | Conv ${fmtNum(market?.bias?.conviction || 0, 0)}%`;

        el.chipGenerated.textContent = `Generated ${fmtTime(state.snapshot.generated_at_utc)}`;
        el.chipReport.textContent = `Report ${fmtDate(market.latest_report_date)} (${market.contract_code})`;
        el.chipIntraday.textContent = `Intraday ${fmtTime(intra.as_of_utc || state.snapshot.generated_at_utc)}`;
        el.chipLastSync.textContent = `Last sync ${localStorage.getItem("aura_last_sync") || "--"}`;

        el.intradayTitle.textContent = `${market.label} Intraday`;
        el.weeklyTitle.textContent = state.chartMode === "trend" ? "Weekly Trend" : "Weekly Shift";
      }

      function render() {
        if (!state.snapshot?.markets) return;
        const market = state.snapshot.markets[state.activeMarket];
        if (!market) return;

        buildTabs();
        renderHeader(market);
        renderSetup(market);
        renderCards(market);
        renderIntradayChart(market);
        renderWeeklyChart(market);
        renderNewsStrip();
      }

      async function loadSnapshot(manual = false) {
        setLoading(true);
        try {
          const res = await fetch(`./data/cot_snapshot.json?ts=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          if (!payload?.markets) throw new Error("Bad snapshot");
          state.snapshot = payload;
          if (!payload.markets[state.activeMarket]) {
            state.activeMarket = Object.keys(payload.markets)[0];
          }

          if (manual || !localStorage.getItem("aura_last_sync")) {
            const now = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            localStorage.setItem("aura_last_sync", now);
          }

          el.error.classList.remove("show");
          render();
        } catch (e) {
          el.error.textContent = `Failed to load data: ${e.message}`;
          el.error.classList.add("show");
        } finally {
          setLoading(false);
        }
      }

      el.syncBtn.addEventListener("click", () => loadSnapshot(true));
      el.modeTrend.addEventListener("click", () => {
        setChartMode("trend");
        if (state.snapshot) render();
      });
      el.modeShift.addEventListener("click", () => {
        setChartMode("shift");
        if (state.snapshot) render();
      });
      el.rfUsd.addEventListener("click", () => {
        setNewsFilter("usd");
        if (state.snapshot) render();
      });
      el.rfAll.addEventListener("click", () => {
        setNewsFilter("all");
        if (state.snapshot) render();
      });

      setChartMode(state.chartMode);
      setNewsFilter(state.newsFilter);
      updateNextCotCountdown();
      setInterval(updateNextCotCountdown, 30000);
      loadSnapshot();
    </script>
  </body>
</html>
