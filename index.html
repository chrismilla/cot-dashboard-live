<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COT Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      :root {
        --bg: #edf2f8;
        --bg-2: #e7eef8;
        --panel: rgba(255, 255, 255, 0.74);
        --panel-strong: rgba(255, 255, 255, 0.92);
        --line: rgba(15, 23, 42, 0.1);
        --line-strong: rgba(15, 23, 42, 0.16);
        --text: #0f172a;
        --muted: #64748b;
        --bull: #16a34a;
        --bear: #dc2626;
        --neutral: #64748b;
        --shadow: 0 24px 50px rgba(15, 23, 42, 0.1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        font-family: "Manrope", sans-serif;
        background:
          radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.2), transparent 34%),
          radial-gradient(circle at 100% 0%, rgba(14, 165, 233, 0.18), transparent 30%),
          radial-gradient(circle at 50% 100%, rgba(168, 85, 247, 0.12), transparent 42%),
          linear-gradient(170deg, var(--bg) 0%, var(--bg-2) 100%);
      }

      .shell {
        width: min(1320px, calc(100% - 1rem));
        margin: 0 auto;
        padding: 1rem 0 1.3rem;
      }

      .glass {
        background: var(--panel);
        border: 1px solid var(--line);
        backdrop-filter: blur(18px) saturate(125%);
        -webkit-backdrop-filter: blur(18px) saturate(125%);
        border-radius: 28px;
        box-shadow: var(--shadow);
      }

      .hero {
        padding: 0.95rem;
      }

      .hero-top {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.75rem;
        align-items: start;
      }

      .eyebrow {
        margin: 0;
        color: #3b82f6;
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-weight: 800;
      }

      h1 {
        margin: 0.2rem 0 0;
        font-size: clamp(1.42rem, 3.2vw, 2.4rem);
        letter-spacing: -0.02em;
        line-height: 1.03;
      }

      .sub {
        margin: 0.34rem 0 0;
        color: var(--muted);
        font-size: 0.84rem;
      }

      .sync {
        border: 1px solid rgba(15, 23, 42, 0.14);
        border-radius: 999px;
        background: linear-gradient(140deg, #ffffff, #eef5ff);
        color: #0f172a;
        font-family: inherit;
        font-weight: 700;
        font-size: 0.78rem;
        padding: 0.44rem 0.86rem;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      }

      .sync:disabled {
        opacity: 0.65;
        cursor: wait;
      }

      .hero-bias {
        margin-top: 0.62rem;
        border-radius: 18px;
        padding: 0.66rem 0.74rem;
        border: 1px solid var(--line);
        background: var(--panel-strong);
      }

      .hero-bias .k {
        margin: 0;
        color: var(--muted);
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .hero-bias .v {
        margin: 0.16rem 0 0;
        font-size: 1.08rem;
        font-weight: 800;
      }

      .hero-bias .m {
        margin: 0.18rem 0 0;
        color: var(--muted);
        font-size: 0.73rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .chips {
        margin-top: 0.62rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.38rem;
      }

      .chip {
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.82);
        padding: 0.24rem 0.54rem;
        color: var(--muted);
        font-size: 0.71rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .tabs {
        margin-top: 0.62rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.42rem;
      }

      .tab {
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.72);
        color: var(--muted);
        padding: 0.62rem;
        font-family: inherit;
        font-size: 0.82rem;
        font-weight: 700;
        cursor: pointer;
        transition: 120ms ease;
      }

      .tab.active {
        background: linear-gradient(145deg, #ffffff, #f0f6ff);
        border-color: rgba(59, 130, 246, 0.35);
        color: #0f172a;
        box-shadow: 0 8px 22px rgba(37, 99, 235, 0.15);
      }

      .plan {
        margin-top: 0.62rem;
        border-radius: 16px;
        border: 1px solid rgba(59, 130, 246, 0.24);
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.86), rgba(239, 246, 255, 0.86));
        padding: 0.62rem 0.74rem;
      }

      .plan b {
        font-size: 0.92rem;
      }

      .plan span {
        display: block;
        margin-top: 0.12rem;
        color: #334155;
        font-size: 0.79rem;
      }

      .grid {
        margin-top: 0.58rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.5rem;
      }

      .card {
        padding: 0.72rem;
        border-radius: 20px;
        border: 1px solid var(--line);
        background: var(--panel-strong);
        box-shadow: 0 16px 34px rgba(15, 23, 42, 0.08);
        min-height: 152px;
      }

      .card.red {
        border-color: rgba(225, 29, 72, 0.24);
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.92), rgba(255, 241, 244, 0.92));
      }

      .label {
        margin: 0;
        color: var(--muted);
        font-size: 0.67rem;
        text-transform: uppercase;
        letter-spacing: 0.11em;
      }

      .card.red .label {
        color: #be123c;
      }

      .big {
        margin: 0.32rem 0 0;
        font-size: clamp(1.36rem, 2.6vw, 2rem);
        line-height: 1;
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .mono {
        font-family: "IBM Plex Mono", monospace;
      }

      .delta {
        margin-top: 0.22rem;
        font-size: 0.79rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .up {
        color: var(--bull);
      }

      .down {
        color: var(--bear);
      }

      .flat {
        color: var(--neutral);
      }

      .mini {
        margin-top: 0.2rem;
        color: var(--muted);
        font-size: 0.72rem;
      }

      .gauge {
        margin-top: 0.56rem;
        height: 16px;
        border-radius: 999px;
        border: 1px solid var(--line-strong);
        background: linear-gradient(90deg, rgba(220, 38, 38, 0.36), rgba(148, 163, 184, 0.16), rgba(22, 163, 74, 0.36));
        position: relative;
      }

      .gauge-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 21px;
        background: #0f172a;
        box-shadow: 0 0 8px rgba(15, 23, 42, 0.35);
      }

      .range {
        margin-top: 0.56rem;
        height: 14px;
        border-radius: 999px;
        border: 1px solid var(--line-strong);
        background: rgba(148, 163, 184, 0.2);
        position: relative;
      }

      .range-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(22, 163, 74, 0.76), rgba(14, 165, 233, 0.78));
      }

      .range-marker {
        position: absolute;
        top: -3px;
        width: 2px;
        height: 20px;
        background: #0f172a;
      }

      .range-meta {
        margin-top: 0.26rem;
        display: flex;
        justify-content: space-between;
        color: var(--muted);
        font-size: 0.69rem;
      }

      .panels {
        margin-top: 0.5rem;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 0.5rem;
      }

      .panel {
        padding: 0.68rem;
        border-radius: 20px;
        border: 1px solid var(--line);
        background: var(--panel);
        backdrop-filter: blur(16px) saturate(118%);
        -webkit-backdrop-filter: blur(16px) saturate(118%);
        box-shadow: var(--shadow);
      }

      .panel-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.35rem;
        flex-wrap: wrap;
      }

      .panel-head h2,
      .panel-head h3 {
        margin: 0;
        font-size: 0.95rem;
      }

      .toggle {
        display: inline-flex;
        border: 1px solid var(--line-strong);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.7);
      }

      .tbtn {
        border: none;
        border-left: 1px solid var(--line-strong);
        background: transparent;
        color: var(--muted);
        padding: 0.32rem 0.52rem;
        font-family: inherit;
        font-size: 0.69rem;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
      }

      .tbtn:first-child {
        border-left: none;
      }

      .tbtn.active {
        background: #ffffff;
        color: #0f172a;
      }

      #intraday-chart,
      #weekly-chart {
        height: 320px;
        margin-top: 0.36rem;
      }

      .news {
        margin-top: 0.5rem;
        padding: 0.68rem;
        border-radius: 20px;
        border: 1px solid rgba(225, 29, 72, 0.22);
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.86), rgba(255, 240, 244, 0.9));
        box-shadow: var(--shadow);
      }

      .news-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.35rem;
        flex-wrap: wrap;
      }

      .news-head h3 {
        margin: 0;
        font-size: 0.95rem;
      }

      .rf-toggle {
        display: inline-flex;
        border: 1px solid rgba(225, 29, 72, 0.24);
        border-radius: 10px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.84);
      }

      .rf-btn {
        border: none;
        border-left: 1px solid rgba(225, 29, 72, 0.24);
        background: transparent;
        color: #9f1239;
        padding: 0.3rem 0.5rem;
        font-family: inherit;
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
      }

      .rf-btn:first-child {
        border-left: none;
      }

      .rf-btn.active {
        background: #ffe4eb;
        color: #881337;
      }

      .news-meta {
        margin: 0.34rem 0 0;
        color: #9f1239;
        font-size: 0.71rem;
        font-family: "IBM Plex Mono", monospace;
      }

      .news-grid {
        margin-top: 0.42rem;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.42rem;
      }

      .news-card {
        border-radius: 14px;
        border: 1px solid rgba(225, 29, 72, 0.24);
        background: rgba(255, 255, 255, 0.86);
        padding: 0.5rem;
      }

      .news-time {
        color: #be123c;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.7rem;
      }

      .news-title {
        margin-top: 0.15rem;
        font-size: 0.79rem;
        line-height: 1.26;
        color: #3f0d1f;
      }

      .cc {
        display: inline-block;
        margin-right: 0.28rem;
        border: 1px solid rgba(225, 29, 72, 0.34);
        border-radius: 999px;
        padding: 0.06rem 0.3rem;
        background: #ffe6ee;
        color: #881337;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.64rem;
      }

      .error {
        margin-top: 0.5rem;
        border-radius: 12px;
        border: 1px solid rgba(220, 38, 38, 0.26);
        background: rgba(254, 226, 226, 0.86);
        color: #991b1b;
        padding: 0.62rem 0.74rem;
        font-size: 0.79rem;
        display: none;
      }

      .error.show {
        display: block;
      }

      footer {
        margin-top: 0.54rem;
        text-align: center;
        color: #64748b;
        font-size: 0.69rem;
      }

      @media (max-width: 1140px) {
        .grid,
        .news-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .panels {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .hero-top {
          grid-template-columns: 1fr;
        }

        .tabs,
        .grid,
        .news-grid {
          grid-template-columns: 1fr;
        }

        #intraday-chart,
        #weekly-chart {
          height: 250px;
        }
      }
    </style>
  </head>
  <body>
    <main class="shell">
      <section class="hero glass">
        <div class="hero-top">
          <div>
            <p class="eyebrow">COT Studio</p>
            <h1 id="hero-market">Loading…</h1>
            <p class="sub">Apple-like, minimal, glance-first.</p>
            <div class="hero-bias">
              <p class="k">Weekly Bias</p>
              <p class="v" id="hero-bias">--</p>
              <p class="m" id="hero-bias-meta">--</p>
            </div>
            <div class="chips">
              <span class="chip" id="chip-generated">Generated --</span>
              <span class="chip" id="chip-report">Report --</span>
              <span class="chip" id="chip-intraday">Intraday --</span>
              <span class="chip" id="chip-next-cot">Next COT --</span>
              <span class="chip" id="chip-last-sync">Last sync --</span>
            </div>
          </div>
          <div><button class="sync" id="sync-btn">Sync</button></div>
        </div>

        <div class="tabs" id="market-tabs"></div>

        <div class="plan">
          <b id="setup-title">Setup --</b>
          <span id="setup-text">Waiting for data...</span>
        </div>
      </section>

      <section class="grid">
        <article class="card">
          <p class="label">Bias Gauge</p>
          <p class="big" id="bias-label">--</p>
          <p class="delta mono" id="bias-score">--</p>
          <div class="gauge"><span class="gauge-marker" id="bias-marker"></span></div>
          <p class="mini" id="bias-mini">--</p>
        </article>

        <article class="card">
          <p class="label">Intraday Price</p>
          <p class="big mono" id="price-last">--</p>
          <p class="delta mono" id="price-change">--</p>
          <p class="mini" id="price-state">--</p>
        </article>

        <article class="card">
          <p class="label">Session Range</p>
          <p class="big mono" id="range-pos">--</p>
          <div class="range">
            <span class="range-fill" id="range-fill"></span>
            <span class="range-marker" id="range-marker"></span>
          </div>
          <div class="range-meta">
            <span id="range-low">Low --</span>
            <span id="range-high">High --</span>
          </div>
        </article>

        <article class="card red">
          <p class="label">Next Red Folder</p>
          <p class="big" id="next-news-title">--</p>
          <p class="delta" id="next-news-time">--</p>
          <p class="mini" id="next-news-meta">--</p>
        </article>
      </section>

      <section class="panels">
        <article class="panel">
          <div class="panel-head"><h2 id="intraday-title">Intraday</h2></div>
          <div id="intraday-chart"></div>
        </article>

        <article class="panel">
          <div class="panel-head">
            <h3 id="weekly-title">Weekly Trend</h3>
            <div class="toggle">
              <button class="tbtn" id="mode-trend">Trend</button>
              <button class="tbtn" id="mode-shift">Shift</button>
            </div>
          </div>
          <div id="weekly-chart"></div>
        </article>
      </section>

      <section class="news">
        <div class="news-head">
          <h3>Forex Factory Red Folder</h3>
          <div class="rf-toggle">
            <button class="rf-btn" id="rf-usd">USD</button>
            <button class="rf-btn" id="rf-all">All</button>
          </div>
        </div>
        <p class="news-meta" id="rf-meta">--</p>
        <div class="news-grid" id="rf-strip"></div>
      </section>

      <div class="error" id="error-box"></div>

      <footer>CFTC + Yahoo + Forex Factory</footer>
    </main>

    <script>
      const MARKET_ORDER = ["dow_jones", "nasdaq_100", "sp_500"];
      const ETF = { dow_jones: "DIA", nasdaq_100: "QQQ", sp_500: "SPY" };

      const state = {
        snapshot: null,
        activeMarket: "dow_jones",
        chartMode: localStorage.getItem("apple_chart_mode") || "trend",
        newsFilter: localStorage.getItem("apple_news_filter") || "usd",
        loading: false,
      };

      const el = {
        syncBtn: document.getElementById("sync-btn"),
        heroMarket: document.getElementById("hero-market"),
        heroBias: document.getElementById("hero-bias"),
        heroBiasMeta: document.getElementById("hero-bias-meta"),
        setupTitle: document.getElementById("setup-title"),
        setupText: document.getElementById("setup-text"),
        chipGenerated: document.getElementById("chip-generated"),
        chipReport: document.getElementById("chip-report"),
        chipIntraday: document.getElementById("chip-intraday"),
        chipNextCot: document.getElementById("chip-next-cot"),
        chipLastSync: document.getElementById("chip-last-sync"),
        marketTabs: document.getElementById("market-tabs"),
        biasLabel: document.getElementById("bias-label"),
        biasScore: document.getElementById("bias-score"),
        biasMarker: document.getElementById("bias-marker"),
        biasMini: document.getElementById("bias-mini"),
        priceLast: document.getElementById("price-last"),
        priceChange: document.getElementById("price-change"),
        priceState: document.getElementById("price-state"),
        rangePos: document.getElementById("range-pos"),
        rangeFill: document.getElementById("range-fill"),
        rangeMarker: document.getElementById("range-marker"),
        rangeLow: document.getElementById("range-low"),
        rangeHigh: document.getElementById("range-high"),
        nextNewsTitle: document.getElementById("next-news-title"),
        nextNewsTime: document.getElementById("next-news-time"),
        nextNewsMeta: document.getElementById("next-news-meta"),
        intradayTitle: document.getElementById("intraday-title"),
        weeklyTitle: document.getElementById("weekly-title"),
        modeTrend: document.getElementById("mode-trend"),
        modeShift: document.getElementById("mode-shift"),
        rfUsd: document.getElementById("rf-usd"),
        rfAll: document.getElementById("rf-all"),
        rfMeta: document.getElementById("rf-meta"),
        rfStrip: document.getElementById("rf-strip"),
        error: document.getElementById("error-box"),
      };

      function fmtNum(v, d = 0) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return n.toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
      }

      function fmtSigned(v, d = 0, suffix = "") {
        const n = Number(v);
        if (!Number.isFinite(n)) return "--";
        return `${n > 0 ? "+" : ""}${fmtNum(n, d)}${suffix}`;
      }

      function toneClass(v) {
        const n = Number(v);
        if (!Number.isFinite(n) || n === 0) return "flat";
        return n > 0 ? "up" : "down";
      }

      function fmtDate(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      }

      function fmtTime(v) {
        const d = new Date(v);
        if (Number.isNaN(d.getTime())) return v || "--";
        return d.toLocaleString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
      }

      function setLoading(flag) {
        state.loading = flag;
        el.syncBtn.disabled = flag;
        el.syncBtn.textContent = flag ? "Syncing..." : "Sync";
      }

      function setChartMode(mode) {
        state.chartMode = mode === "shift" ? "shift" : "trend";
        localStorage.setItem("apple_chart_mode", state.chartMode);
        el.modeTrend.classList.toggle("active", state.chartMode === "trend");
        el.modeShift.classList.toggle("active", state.chartMode === "shift");
      }

      function setNewsFilter(mode) {
        state.newsFilter = mode === "all" ? "all" : "usd";
        localStorage.setItem("apple_news_filter", state.newsFilter);
        el.rfUsd.classList.toggle("active", state.newsFilter === "usd");
        el.rfAll.classList.toggle("active", state.newsFilter === "all");
      }

      function updateNextCotCountdown() {
        const nowNY = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
        const next = new Date(nowNY);
        const dayDiff = (5 - nowNY.getDay() + 7) % 7;
        next.setDate(nowNY.getDate() + dayDiff);
        next.setHours(15, 30, 0, 0);
        if (nowNY.getDay() === 5 && nowNY.getTime() >= next.getTime()) {
          next.setDate(next.getDate() + 7);
        }
        const diff = Math.max(0, next.getTime() - nowNY.getTime());
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        el.chipNextCot.textContent = `Next COT ${d}d ${h}h ${m}m`;
      }

      function buildTabs() {
        const markets = state.snapshot?.markets || {};
        el.marketTabs.innerHTML = "";
        MARKET_ORDER.forEach((key) => {
          const market = markets[key];
          if (!market) return;
          const btn = document.createElement("button");
          btn.className = `tab ${key === state.activeMarket ? "active" : ""}`;
          btn.textContent = market.label;
          btn.addEventListener("click", () => {
            state.activeMarket = key;
            render();
          });
          el.marketTabs.appendChild(btn);
        });
      }

      function getUpcomingNews() {
        const rf = state.snapshot?.news?.red_folder || {};
        const all = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        return state.newsFilter === "usd" ? all.filter((e) => e.country === "USD") : all;
      }

      function renderSetup(market) {
        const score = Number(market?.bias?.score || 0);
        const chg = Number(market?.intraday?.change_pct || 0);

        let title = "Neutral Week";
        let text = "Wait for clean confirmation before sizing up.";
        if (score >= 20) {
          title = "Bullish Week";
          text = "Favor long continuation setups on controlled pullbacks.";
        } else if (score <= -20) {
          title = "Bearish Week";
          text = "Favor short continuation setups after bounce failures.";
        }
        if (Math.abs(chg) > 1.2) {
          text += " Volatility elevated.";
        }

        el.setupTitle.textContent = title;
        el.setupText.textContent = text;
      }

      function renderCards(market) {
        const bias = market?.bias || {};
        const intra = market?.intraday || {};

        const score = Number(bias.score || 0);
        el.biasLabel.textContent = bias.label || "Neutral";
        el.biasScore.className = `delta mono ${toneClass(score)}`;
        el.biasScore.textContent = `Score ${fmtSigned(score, 1)} | Conv ${fmtNum(bias.conviction || 0, 0)}%`;
        el.biasMini.textContent = `Asset pct ${fmtNum(bias.asset_percentile || 0, 1)} | Lev pct ${fmtNum(bias.leveraged_percentile || 0, 1)}`;
        el.biasMarker.style.left = `${Math.max(0, Math.min(100, (score + 100) / 2))}%`;

        const ticker = intra.symbol || ETF[state.activeMarket] || "--";
        const chgPct = Number(intra.change_pct || 0);
        el.priceLast.textContent = `${ticker} ${fmtNum(intra.last, 2)}`;
        el.priceChange.className = `delta mono ${toneClass(chgPct)}`;
        el.priceChange.textContent = `${fmtSigned(intra.change, 2)} (${fmtSigned(chgPct, 2, "%")})`;
        el.priceState.textContent = intra.market_state ? `State ${intra.market_state}` : "State --";

        const rp = Math.max(0, Math.min(100, Number(intra.range_position_pct || 0)));
        el.rangePos.textContent = `${fmtNum(rp, 1)}%`;
        el.rangeFill.style.width = `${rp}%`;
        el.rangeMarker.style.left = `${rp}%`;
        el.rangeLow.textContent = `Low ${fmtNum(intra.day_low, 2)}`;
        el.rangeHigh.textContent = `High ${fmtNum(intra.day_high, 2)}`;

        const news = getUpcomingNews();
        const next = news[0];
        if (next) {
          el.nextNewsTitle.textContent = `${next.country || "--"} ${next.title || "Event"}`;
          el.nextNewsTime.textContent = fmtTime(next.datetime_utc || `${next.date} ${next.time}`);
          el.nextNewsMeta.textContent = `${news.length} upcoming ${state.newsFilter.toUpperCase()}`;
        } else {
          el.nextNewsTitle.textContent = "No upcoming red-folder";
          el.nextNewsTime.textContent = "--";
          el.nextNewsMeta.textContent = "No events in filter";
        }
      }

      function renderIntradayChart(market) {
        const intra = market?.intraday || {};
        const bars = Array.isArray(intra.bars) ? intra.bars : [];

        if (bars.length < 2 || intra.error) {
          Plotly.react(
            "intraday-chart",
            [],
            {
              margin: { l: 32, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(255,255,255,0.72)",
              font: { family: "Manrope, sans-serif", color: "#334155" },
              annotations: [{ text: "No intraday bars", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false }],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = bars.map((b) => b.t);
        const y = bars.map((b) => b.c);
        const bullish = Number(intra.change_pct || 0) >= 0;
        const color = bullish ? "#16a34a" : "#dc2626";

        Plotly.react(
          "intraday-chart",
          [{ type: "scatter", mode: "lines", x, y, line: { color, width: 3 }, fill: "tozeroy", fillcolor: bullish ? "rgba(22,163,74,0.18)" : "rgba(220,38,38,0.16)", hovertemplate: "%{x}<br>%{y:.2f}<extra></extra>" }],
          {
            margin: { l: 44, r: 12, t: 8, b: 30 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(255,255,255,0.72)",
            font: { family: "Manrope, sans-serif", color: "#334155" },
            hovermode: "x unified",
            xaxis: { type: "date", tickformat: "%H:%M", gridcolor: "rgba(100,116,139,0.16)" },
            yaxis: { gridcolor: "rgba(100,116,139,0.2)", zeroline: false },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderWeeklyChart(market) {
        const history = Array.isArray(market.history) ? market.history : [];

        if (history.length < 2) {
          Plotly.react(
            "weekly-chart",
            [],
            {
              margin: { l: 32, r: 10, t: 10, b: 24 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(255,255,255,0.72)",
              annotations: [{ text: "No weekly rows", x: 0.5, y: 0.5, xref: "paper", yref: "paper", showarrow: false }],
              xaxis: { visible: false },
              yaxis: { visible: false },
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        if (state.chartMode === "shift") {
          const latest = history[history.length - 1];
          const prev = history[history.length - 2];
          const labels = ["Asset", "Leveraged", "OI"];
          const vals = [
            Number(latest.asset_mgr_net || 0) - Number(prev.asset_mgr_net || 0),
            Number(latest.leveraged_net || 0) - Number(prev.leveraged_net || 0),
            Number(latest.open_interest || 0) - Number(prev.open_interest || 0),
          ];
          const colors = vals.map((v) => (v >= 0 ? "rgba(22,163,74,0.9)" : "rgba(220,38,38,0.9)"));

          Plotly.react(
            "weekly-chart",
            [{ type: "bar", x: labels, y: vals, marker: { color: colors, line: { color: "rgba(15,23,42,0.3)", width: 1 } }, text: vals.map((v) => fmtSigned(v)), textposition: "outside", hovertemplate: "%{x} Δ %{y:,}<extra></extra>" }],
            {
              margin: { l: 44, r: 12, t: 20, b: 36 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(255,255,255,0.72)",
              font: { family: "Manrope, sans-serif", color: "#334155" },
              yaxis: { gridcolor: "rgba(100,116,139,0.2)", zerolinecolor: "rgba(100,116,139,0.35)" },
              annotations: [{ text: `${fmtDate(prev.report_date)} → ${fmtDate(latest.report_date)}`, x: 0, y: 1.14, xref: "paper", yref: "paper", showarrow: false, font: { size: 11, color: "#64748b" } }],
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const x = history.map((h) => h.report_date);
        const asset = history.map((h) => h.asset_mgr_net);
        const lev = history.map((h) => h.leveraged_net);

        Plotly.react(
          "weekly-chart",
          [
            { type: "scatter", mode: "lines", x, y: asset, name: "Asset", line: { color: "#f59e0b", width: 3 } },
            { type: "scatter", mode: "lines", x, y: lev, name: "Leveraged", line: { color: "#0284c7", width: 3 } },
          ],
          {
            margin: { l: 44, r: 12, t: 10, b: 30 },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(255,255,255,0.72)",
            font: { family: "Manrope, sans-serif", color: "#334155" },
            hovermode: "x unified",
            legend: { orientation: "h", y: 1.12, x: 0 },
            xaxis: { type: "date", tickformat: "%b %Y", gridcolor: "rgba(100,116,139,0.16)" },
            yaxis: { gridcolor: "rgba(100,116,139,0.2)", zerolinecolor: "rgba(100,116,139,0.35)" },
          },
          { displayModeBar: false, responsive: true }
        );
      }

      function renderNewsStrip() {
        const rf = state.snapshot?.news?.red_folder || {};
        const all = Array.isArray(rf.upcoming_high_impact) ? rf.upcoming_high_impact : [];
        const list = state.newsFilter === "usd" ? all.filter((e) => e.country === "USD") : all;
        const show = list.slice(0, 8);

        const fetched = rf.fetched_at_utc ? fmtTime(rf.fetched_at_utc) : "--";
        el.rfMeta.textContent = `${list.length} events | ${state.newsFilter.toUpperCase()} | feed ${fetched}`;

        if (!show.length) {
          el.rfStrip.innerHTML = `<div class="news-card"><div class="news-title">No high-impact events in this filter.</div></div>`;
          return;
        }

        el.rfStrip.innerHTML = show
          .map((e) => {
            const t = e.datetime_utc ? fmtTime(e.datetime_utc) : `${e.date || "--"} ${e.time || "--"}`;
            return `<article class="news-card"><div class="news-time">${t}</div><div class="news-title"><span class="cc">${e.country || "--"}</span>${e.title || "Event"}</div></article>`;
          })
          .join("");
      }

      function renderHeader(market) {
        const intra = market?.intraday || {};
        const score = Number(market?.bias?.score || 0);

        el.heroMarket.textContent = `${market.label} • ${intra.symbol || ETF[state.activeMarket] || "--"}`;
        el.heroBias.textContent = market?.bias?.label || "Neutral";
        el.heroBias.className = `v ${toneClass(score)}`;
        el.heroBiasMeta.textContent = `Score ${fmtSigned(score, 1)} | Conv ${fmtNum(market?.bias?.conviction || 0, 0)}%`;

        el.chipGenerated.textContent = `Generated ${fmtTime(state.snapshot.generated_at_utc)}`;
        el.chipReport.textContent = `Report ${fmtDate(market.latest_report_date)} (${market.contract_code})`;
        el.chipIntraday.textContent = `Intraday ${fmtTime(intra.as_of_utc || state.snapshot.generated_at_utc)}`;
        el.chipLastSync.textContent = `Last sync ${localStorage.getItem("apple_last_sync") || "--"}`;

        el.intradayTitle.textContent = `${market.label} Intraday`;
        el.weeklyTitle.textContent = state.chartMode === "trend" ? "Weekly Trend" : "Weekly Shift";
      }

      function render() {
        if (!state.snapshot?.markets) return;
        const market = state.snapshot.markets[state.activeMarket];
        if (!market) return;

        buildTabs();
        renderHeader(market);
        renderSetup(market);
        renderCards(market);
        renderIntradayChart(market);
        renderWeeklyChart(market);
        renderNewsStrip();
      }

      async function loadSnapshot(manual = false) {
        setLoading(true);
        try {
          const res = await fetch(`./data/cot_snapshot.json?ts=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          if (!payload?.markets) throw new Error("Bad snapshot");
          state.snapshot = payload;

          if (!payload.markets[state.activeMarket]) {
            state.activeMarket = Object.keys(payload.markets)[0];
          }

          if (manual || !localStorage.getItem("apple_last_sync")) {
            const now = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            localStorage.setItem("apple_last_sync", now);
          }

          el.error.classList.remove("show");
          render();
        } catch (e) {
          el.error.textContent = `Failed to load data: ${e.message}`;
          el.error.classList.add("show");
        } finally {
          setLoading(false);
        }
      }

      el.syncBtn.addEventListener("click", () => loadSnapshot(true));
      el.modeTrend.addEventListener("click", () => {
        setChartMode("trend");
        if (state.snapshot) render();
      });
      el.modeShift.addEventListener("click", () => {
        setChartMode("shift");
        if (state.snapshot) render();
      });
      el.rfUsd.addEventListener("click", () => {
        setNewsFilter("usd");
        if (state.snapshot) render();
      });
      el.rfAll.addEventListener("click", () => {
        setNewsFilter("all");
        if (state.snapshot) render();
      });

      setChartMode(state.chartMode);
      setNewsFilter(state.newsFilter);
      updateNextCotCountdown();
      setInterval(updateNextCotCountdown, 30000);
      loadSnapshot();
    </script>
  </body>
</html>
