<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COT Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        content: ["./**/*.{html,js}"],
        theme: { extend: { fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] } } },
      };
      document.documentElement.classList.add("dark");
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
      :root {
        --bg: #07090d;
        --bg-soft: #0f131b;
        --card: rgba(255, 255, 255, 0.05);
        --card-strong: rgba(255, 255, 255, 0.08);
        --line: rgba(255, 255, 255, 0.12);
        --text: #f5f7fb;
        --muted: #a1a7b5;
        --soft: #7e8798;
        --bull: #34d399;
        --bear: #fb7185;
        --neutral: #fbbf24;
        --focus: #4f9cf7;
        --track: rgba(255, 255, 255, 0.15);
        --shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
        --radius: 24px;
      }

      :root[data-theme="light"] {
        --bg: #f4f6fb;
        --bg-soft: #edf1f8;
        --card: rgba(255, 255, 255, 0.76);
        --card-strong: rgba(255, 255, 255, 0.92);
        --line: rgba(15, 23, 42, 0.12);
        --text: #101727;
        --muted: #5f6a7f;
        --soft: #7b879b;
        --track: rgba(100, 116, 139, 0.2);
        --shadow: 0 24px 66px rgba(15, 23, 42, 0.14);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        scroll-behavior: smooth;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text);
        background-color: #0a0a0a;
        background:
          radial-gradient(circle at 11% -10%, rgba(16, 185, 129, 0.12), transparent 34%),
          radial-gradient(circle at 91% -12%, rgba(59, 130, 246, 0.13), transparent 38%),
          var(--bg);
      }

      .wrap {
        width: min(1320px, calc(100% - 2rem));
        margin: 0 auto;
        padding: 1.2rem 0 2.4rem;
      }

      .glass {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: var(--shadow);
        backdrop-filter: blur(24px) saturate(145%);
        -webkit-backdrop-filter: blur(24px) saturate(145%);
      }

      .nav {
        position: sticky;
        top: 0.8rem;
        z-index: 40;
        border-radius: 16px;
        padding: 0.68rem 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.65rem;
      }

      .brand-mark {
        width: 28px;
        height: 28px;
        border-radius: 9px;
        background: linear-gradient(135deg, #22d3ee, #3b82f6);
        display: grid;
        place-items: center;
        font-size: 0.65rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        color: #fff;
      }

      .brand h1 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .menu {
        display: inline-flex;
        align-items: center;
        gap: 0.18rem;
        padding: 0.18rem;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--card-strong);
      }

      .menu a {
        text-decoration: none;
        color: var(--muted);
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        padding: 0.36rem 0.64rem;
        border-radius: 999px;
        transition: 140ms ease;
      }

      .menu a:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.08);
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.45rem;
      }

      .sync-readout {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.52rem;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--card-strong);
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--bull);
        box-shadow: 0 0 16px var(--bull);
        animation: blink 1.7s ease-in-out infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .sync-copy {
        line-height: 1.15;
      }

      .sync-state {
        font-size: 0.64rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--soft);
      }

      .sync-time {
        margin-top: 0.11rem;
        font-size: 0.76rem;
        font-weight: 600;
      }

      .btn {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 0.44rem 0.78rem;
        font: inherit;
        font-size: 0.74rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        cursor: pointer;
        color: var(--text);
        background: var(--card-strong);
        transition: 130ms ease;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn-sync {
        border-color: rgba(52, 211, 153, 0.55);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.28), rgba(52, 211, 153, 0.08));
      }

      .btn-ghost {
        background: transparent;
      }

      .mt {
        margin-top: 0.9rem;
      }

      .market-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
        margin-top: 0.72rem;
      }

      .market-tab {
        border: 1px solid var(--line);
        color: var(--muted);
        background: var(--card);
        border-radius: 12px;
        padding: 0.48rem 0.78rem;
        font: inherit;
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
        transition: 130ms ease;
      }

      .market-tab.active {
        color: var(--text);
        border-color: rgba(79, 156, 247, 0.5);
        background: linear-gradient(135deg, rgba(79, 156, 247, 0.2), rgba(79, 156, 247, 0.05));
      }

      .hero {
        border-radius: var(--radius);
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
      }

      .hero::after {
        content: "";
        position: absolute;
        width: 380px;
        height: 380px;
        border-radius: 999px;
        right: -150px;
        top: -200px;
        background: radial-gradient(circle, rgba(59, 130, 246, 0.26), transparent 68%);
        pointer-events: none;
      }

      .hero-grid {
        display: grid;
        grid-template-columns: 230px 1fr;
        gap: 1.35rem;
        align-items: center;
      }

      .gauge {
        --score: 50;
        --accent: var(--neutral);
        width: 220px;
        height: 220px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: conic-gradient(var(--accent) calc(var(--score) * 1%), var(--track) 0);
        position: relative;
      }

      .gauge::before {
        content: "";
        width: 172px;
        height: 172px;
        border-radius: 50%;
        border: 1px solid var(--line);
        background: var(--bg-soft);
      }

      .gauge.pulse {
        animation: gaugePulse 2.5s ease-in-out infinite;
      }

      @keyframes gaugePulse {
        0%,
        100% {
          box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }
        50% {
          box-shadow: 0 0 48px color-mix(in srgb, var(--accent) 32%, transparent);
        }
      }

      .gauge-copy {
        position: absolute;
        text-align: center;
      }

      .gauge-score {
        font-size: 3.1rem;
        font-weight: 900;
        letter-spacing: -0.04em;
        line-height: 1;
      }

      .gauge-label {
        font-size: 0.66rem;
        letter-spacing: 0.11em;
        text-transform: uppercase;
        color: var(--muted);
        margin-top: 0.2rem;
      }

      .hero-copy {
        position: relative;
        z-index: 2;
      }

      .hero-market {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--soft);
      }

      .bias-word {
        margin: 0.38rem 0 0;
        font-size: clamp(2.5rem, 8.1vw, 6.9rem);
        font-weight: 900;
        letter-spacing: -0.06em;
        line-height: 0.92;
      }

      .is-bull {
        color: var(--bull);
      }

      .is-bear {
        color: var(--bear);
      }

      .is-neutral {
        color: var(--neutral);
      }

      .confluence-line {
        margin-top: 0.72rem;
        font-size: 1.02rem;
        color: var(--muted);
        font-weight: 600;
      }

      .bar {
        margin-top: 0.56rem;
        height: 10px;
        border-radius: 999px;
        background: var(--track);
        overflow: hidden;
      }

      .bar-fill {
        height: 100%;
        width: 0;
        transition: width 280ms ease;
      }

      .playbook {
        margin-top: 1rem;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: var(--card-strong);
        padding: 0.85rem 1rem;
      }

      .playbook-line {
        margin: 0;
        font-size: 0.96rem;
        font-weight: 600;
      }

      .playbook-list {
        list-style: none;
        margin: 0.58rem 0 0;
        padding: 0;
        display: grid;
        gap: 0.35rem;
      }

      .playbook-list li {
        color: var(--muted);
        font-size: 0.82rem;
      }

      .grid-2 {
        margin-top: 0.9rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.9rem;
      }

      .panel {
        border-radius: var(--radius);
        padding: 1.1rem;
        transition: transform 160ms ease, border-color 160ms ease;
      }

      .panel:hover {
        transform: translateY(-4px);
        border-color: color-mix(in srgb, var(--focus) 40%, var(--line));
      }

      .panel-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.65rem;
      }

      .panel h2,
      .panel h3 {
        margin: 0;
      }

      .kicker {
        margin: 0.3rem 0 0;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .pulse-meta {
        margin-top: 0.72rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.5rem;
      }

      .metric {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 0.62rem;
        background: var(--card-strong);
      }

      .metric .k {
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--soft);
      }

      .metric .v {
        margin-top: 0.2rem;
        font-size: 1.08rem;
        font-weight: 700;
      }

      .pulse-score {
        font-size: 2.2rem;
        font-weight: 800;
        letter-spacing: -0.04em;
      }

      .pulse-tag {
        font-size: 0.75rem;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .price {
        font-size: 1.9rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        transition: color 220ms ease, text-shadow 220ms ease;
      }

      .price.flash-up {
        color: var(--bull);
        text-shadow: 0 0 28px rgba(52, 211, 153, 0.45);
      }

      .price.flash-down {
        color: var(--bear);
        text-shadow: 0 0 28px rgba(251, 113, 133, 0.38);
      }

      .price-change {
        margin-top: 0.2rem;
        font-size: 0.82rem;
        color: var(--muted);
      }

      .chips {
        margin-top: 0.65rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .chip {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 0.3rem 0.55rem;
        font-size: 0.72rem;
        color: var(--muted);
        background: var(--card-strong);
      }

      #pulse-chart {
        margin-top: 0.8rem;
        height: 280px;
      }

      .detail-grid {
        margin-top: 0.8rem;
        display: grid;
        gap: 0.52rem;
      }

      .row {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--card-strong);
        padding: 0.56rem 0.65rem;
      }

      .row-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        font-size: 0.76rem;
      }

      .row-value {
        font-size: 0.84rem;
        font-weight: 700;
      }

      .mini-bar {
        margin-top: 0.38rem;
        height: 7px;
        border-radius: 999px;
        overflow: hidden;
        background: var(--track);
      }

      .mini-bar > span {
        display: block;
        height: 100%;
        width: 0;
      }

      .split {
        margin-top: 0.9rem;
        display: grid;
        grid-template-columns: 1.36fr 0.84fr;
        gap: 0.9rem;
      }

      .segment {
        display: inline-flex;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: var(--card-strong);
        padding: 0.18rem;
      }

      .segment button {
        border: 0;
        background: transparent;
        color: var(--muted);
        font: inherit;
        font-size: 0.73rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        border-radius: 999px;
        padding: 0.35rem 0.62rem;
        cursor: pointer;
      }

      .segment button.active {
        color: var(--text);
        background: rgba(79, 156, 247, 0.2);
      }

      #cot-chart {
        margin-top: 0.85rem;
        height: 355px;
      }

      .event-list {
        margin-top: 0.72rem;
        display: grid;
        gap: 0.45rem;
        max-height: 355px;
        overflow: auto;
        padding-right: 0.2rem;
      }

      .event {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--card-strong);
        padding: 0.58rem 0.65rem;
      }

      .event-top {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .event-title {
        font-size: 0.84rem;
        font-weight: 700;
        line-height: 1.25;
      }

      .event-tag {
        color: var(--bear);
        font-size: 0.66rem;
        letter-spacing: 0.09em;
        text-transform: uppercase;
      }

      .event-meta {
        margin-top: 0.28rem;
        color: var(--muted);
        font-size: 0.74rem;
      }

      .alert-row {
        margin-top: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.42rem;
        align-items: center;
      }

      .alert-status {
        margin-top: 0.4rem;
        font-size: 0.72rem;
        color: var(--muted);
      }

      .watch-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-top: 0.8rem;
      }

      .watch-controls {
        display: flex;
        align-items: center;
        gap: 0.42rem;
      }

      select {
        border-radius: 10px;
        border: 1px solid var(--line);
        background: var(--card-strong);
        color: var(--text);
        padding: 0.4rem 0.48rem;
        font: inherit;
        font-size: 0.78rem;
      }

      .watch-grid {
        margin-top: 0.62rem;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.52rem;
      }

      .watch {
        border-radius: 14px;
        border: 1px solid var(--line);
        background: var(--card-strong);
        padding: 0.54rem;
        cursor: pointer;
        transition: 130ms ease;
      }

      .watch:hover {
        border-color: color-mix(in srgb, var(--focus) 38%, var(--line));
      }

      .watch.active {
        border-color: color-mix(in srgb, var(--focus) 56%, var(--line));
      }

      .watch-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .watch-symbol {
        font-size: 0.88rem;
        font-weight: 700;
      }

      .watch-remove {
        border: 0;
        background: transparent;
        color: var(--soft);
        font-size: 0.86rem;
        cursor: pointer;
      }

      .watch-score {
        margin-top: 0.22rem;
        font-size: 0.79rem;
        font-weight: 700;
      }

      .watch-meta {
        margin-top: 0.2rem;
        font-size: 0.72rem;
        color: var(--muted);
      }

      .history {
        margin-top: 0.9rem;
      }

      .table-wrap {
        margin-top: 0.5rem;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 640px;
      }

      th,
      td {
        border-top: 1px solid var(--line);
        padding: 0.52rem 0.4rem;
        text-align: right;
        font-size: 0.78rem;
      }

      th {
        color: var(--soft);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.66rem;
        border-top: none;
      }

      td:first-child,
      th:first-child {
        text-align: left;
      }

      .pill {
        display: inline-block;
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 0.22rem 0.5rem;
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .muted {
        color: var(--muted);
      }

      .error {
        margin-top: 0.8rem;
        border-radius: 14px;
        border: 1px solid rgba(251, 113, 133, 0.42);
        background: rgba(251, 113, 133, 0.14);
        color: #fecdd3;
        padding: 0.65rem 0.75rem;
        font-size: 0.82rem;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 1120px) {
        .hero-grid {
          grid-template-columns: 1fr;
          justify-items: center;
          text-align: center;
          gap: 1rem;
        }

        .hero-copy {
          width: 100%;
        }

        .confluence-line {
          font-size: 0.9rem;
        }

        .grid-2,
        .split {
          grid-template-columns: 1fr;
        }

        .watch-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 820px) {
        .wrap {
          width: min(1320px, calc(100% - 1rem));
        }

        .nav {
          top: 0.45rem;
          border-radius: 14px;
          flex-wrap: wrap;
          gap: 0.6rem;
        }

        .menu {
          order: 3;
          width: 100%;
          justify-content: space-between;
        }

        .menu a {
          flex: 1;
          text-align: center;
          font-size: 0.67rem;
          padding: 0.34rem 0.25rem;
        }

        .hero {
          padding: 1rem;
        }

        .gauge {
          width: 180px;
          height: 180px;
        }

        .gauge::before {
          width: 138px;
          height: 138px;
        }

        .gauge-score {
          font-size: 2.45rem;
        }

        .pulse-meta {
          grid-template-columns: 1fr;
        }

        .watch-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header class="nav glass">
        <div class="brand">
          <div class="brand-mark">COT</div>
          <h1>COT Studio</h1>
        </div>

        <nav class="menu">
          <a href="#bias-section">Bias</a>
          <a href="#intraday-section">Intraday</a>
          <a href="#reports-section">Reports</a>
          <a href="#events-section">Next COT</a>
        </nav>

        <div class="nav-right">
          <div class="sync-readout">
            <span class="dot" id="sync-dot"></span>
            <div class="sync-copy">
              <div class="sync-state" id="sync-state">Live</div>
              <div class="sync-time" id="sync-time">Waiting for snapshot...</div>
            </div>
          </div>
          <button class="btn btn-sync" id="sync-btn">Sync</button>
          <button class="btn btn-ghost" id="theme-toggle">Light</button>
        </div>
      </header>

      <div id="error-box" class="error hidden"></div>

      <section class="mt" id="bias-section">
        <div class="market-tabs" id="market-tabs"></div>
        <div class="max-w-5xl mx-auto px-2 pt-3">
          <div class="glass rounded-3xl p-12 shadow-2xl">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8">
              <div class="min-w-0">
                <p class="hero-market text-zinc-500" id="hero-market">--</p>
                <h2
                  class="font-black leading-none tracking-[-4px] text-[clamp(3rem,9vw,6rem)] text-emerald-400"
                  id="bias-word"
                >
                  NEUTRAL
                </h2>
                <div id="confluence-line" class="text-[clamp(1.45rem,3.8vw,2.75rem)] font-light text-zinc-400 mt-3">
                  COT -- + Technical --
                </div>
                <div class="mt-4 h-2.5 rounded-full bg-white/10 overflow-hidden">
                  <div id="confluence-fill" class="h-full rounded-full transition-all duration-300"></div>
                </div>
              </div>

              <div id="bias-gauge" class="gauge shrink-0 mx-auto lg:mx-0">
                <div class="gauge-copy">
                  <div class="gauge-score" id="bias-score">--</div>
                  <div class="gauge-label">Confluence</div>
                </div>
              </div>
            </div>

            <p id="playbook-line" class="mt-8 text-[clamp(1.1rem,2.8vw,1.7rem)] text-zinc-300 leading-tight">
              Waiting for updated bias...
            </p>
            <ul id="playbook-list" class="mt-4 text-zinc-400 text-base leading-relaxed space-y-1"></ul>
          </div>
        </div>
      </section>

      <section class="grid-2" id="intraday-section">
        <article class="panel glass">
          <div class="panel-head">
            <div>
              <h2>Intraday Pulse</h2>
              <p class="kicker" id="pulse-kicker">5m structure + session filters</p>
            </div>
            <span class="pill" id="pulse-tag">--</span>
          </div>

          <div class="pulse-meta">
            <div class="metric">
              <div class="k">Pulse Score</div>
              <div class="v pulse-score" id="pulse-score">--</div>
            </div>
            <div class="metric">
              <div class="k">Price</div>
              <div class="v price" id="price-value">--</div>
              <div class="price-change" id="price-change">--</div>
            </div>
            <div class="metric">
              <div class="k">Session</div>
              <div class="v" id="session-structure">--</div>
              <div class="price-change" id="session-time">--</div>
            </div>
          </div>

          <div class="chips" id="intraday-metrics"></div>
          <div id="pulse-chart"></div>
        </article>

        <article class="panel glass">
          <div class="panel-head">
            <div>
              <h2>Weekly Bias Detail</h2>
              <p class="kicker" id="detail-kicker">COT component pressure + technical levels</p>
            </div>
            <span class="pill" id="next-release">--</span>
          </div>

          <div class="detail-grid" id="component-grid"></div>
          <div class="detail-grid" id="level-grid"></div>
        </article>
      </section>

      <section class="split" id="reports-section">
        <article class="panel glass">
          <div class="panel-head">
            <div>
              <h2 id="chart-title">Positioning Trend</h2>
              <p class="kicker" id="chart-sub">--</p>
            </div>
            <div class="segment">
              <button id="mode-trend" class="active">Trend</button>
              <button id="mode-shift">Shift</button>
            </div>
          </div>
          <div id="cot-chart"></div>
        </article>

        <article class="panel glass" id="events-section">
          <div class="panel-head">
            <div>
              <h3>Red Folder</h3>
              <p class="kicker">Major USD macro/Fed events for SPY, QQQ, DIA</p>
            </div>
            <span class="pill" id="red-count">0 events</span>
          </div>
          <div class="alert-row">
            <select id="alert-lead" aria-label="Alert lead time">
              <option value="60">60 min before</option>
              <option value="30">30 min before</option>
              <option value="15" selected>15 min before</option>
              <option value="10">10 min before</option>
              <option value="5">5 min before</option>
            </select>
            <button class="btn btn-ghost" id="alert-toggle">Enable Alerts</button>
          </div>
          <div class="alert-status" id="alert-status">Alerts off</div>
          <div class="event-list" id="red-events"></div>
        </article>
      </section>

      <section class="panel glass watch-section">
        <div class="watch-head">
          <div>
            <h3>Watchlist</h3>
            <p class="kicker">Pin up to 6 symbols (local storage)</p>
          </div>
          <div class="watch-controls">
            <select id="symbol-picker"></select>
            <button class="btn btn-ghost" id="pin-symbol">Pin</button>
          </div>
        </div>
        <div class="watch-grid" id="watch-grid"></div>
      </section>

      <section class="panel glass history">
        <div class="panel-head">
          <div>
            <h3>Latest Reports</h3>
            <p class="kicker" id="history-caption">--</p>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Report Date</th>
                <th>Asset Net</th>
                <th>Lev Net</th>
                <th>Open Interest</th>
              </tr>
            </thead>
            <tbody id="history-body"></tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      const DEFAULT_MARKET_ORDER = ["dow_jones", "nasdaq_100", "sp_500", "dxy"];
      const DEFAULT_PINNED = ["DIA", "QQQ", "SPY", "DX-Y.NYB"];
      const GITHUB_REFRESH = {
        owner: "chrismilla",
        repo: "cot-dashboard-live",
        workflowFile: "refresh-data.yml",
        ref: "main",
        tokenStorageKey: "cot_github_pat",
      };
      const ALERT_STORAGE = {
        enabled: "cot_news_alerts_enabled",
        lead: "cot_news_alert_lead_minutes",
        seen: "cot_news_alert_seen",
      };

      const state = {
        snapshot: null,
        activeMarket: "sp_500",
        chartMode: "trend",
        theme: localStorage.getItem("cot_theme") || "dark",
        pinnedSymbols: [],
        lastPriceByMarket: {},
        refreshInFlight: false,
        alertsEnabled: false,
        alertLeadMinutes: 15,
        alertedEventKeys: new Set(),
        alertTimerId: null,
      };

      const el = {
        syncDot: document.getElementById("sync-dot"),
        syncState: document.getElementById("sync-state"),
        syncTime: document.getElementById("sync-time"),
        syncBtn: document.getElementById("sync-btn"),
        themeToggle: document.getElementById("theme-toggle"),
        errorBox: document.getElementById("error-box"),

        marketTabs: document.getElementById("market-tabs"),

        biasGauge: document.getElementById("bias-gauge"),
        biasScore: document.getElementById("bias-score"),
        biasWord: document.getElementById("bias-word"),
        heroMarket: document.getElementById("hero-market"),
        confluenceLine: document.getElementById("confluence-line"),
        confluenceFill: document.getElementById("confluence-fill"),
        playbookLine: document.getElementById("playbook-line"),
        playbookList: document.getElementById("playbook-list"),

        pulseTag: document.getElementById("pulse-tag"),
        pulseScore: document.getElementById("pulse-score"),
        priceValue: document.getElementById("price-value"),
        priceChange: document.getElementById("price-change"),
        sessionStructure: document.getElementById("session-structure"),
        sessionTime: document.getElementById("session-time"),
        pulseKicker: document.getElementById("pulse-kicker"),
        intradayMetrics: document.getElementById("intraday-metrics"),

        detailKicker: document.getElementById("detail-kicker"),
        nextRelease: document.getElementById("next-release"),
        componentGrid: document.getElementById("component-grid"),
        levelGrid: document.getElementById("level-grid"),

        chartTitle: document.getElementById("chart-title"),
        chartSub: document.getElementById("chart-sub"),
        modeTrend: document.getElementById("mode-trend"),
        modeShift: document.getElementById("mode-shift"),

        redCard: document.getElementById("events-section"),
        redCount: document.getElementById("red-count"),
        redEvents: document.getElementById("red-events"),
        alertLead: document.getElementById("alert-lead"),
        alertToggle: document.getElementById("alert-toggle"),
        alertStatus: document.getElementById("alert-status"),

        symbolPicker: document.getElementById("symbol-picker"),
        pinSymbol: document.getElementById("pin-symbol"),
        watchGrid: document.getElementById("watch-grid"),

        historyCaption: document.getElementById("history-caption"),
        historyBody: document.getElementById("history-body"),
      };

      function setTheme(theme) {
        state.theme = theme;
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("cot_theme", theme);
        el.themeToggle.textContent = theme === "dark" ? "Light" : "Dark";
      }

      function loadPinned() {
        try {
          const stored = JSON.parse(localStorage.getItem("cot_pinned_symbols") || "[]");
          if (Array.isArray(stored) && stored.length) {
            state.pinnedSymbols = stored;
            return;
          }
        } catch (_) {
          // Ignore malformed storage values.
        }
        state.pinnedSymbols = [...DEFAULT_PINNED];
      }

      function savePinned() {
        localStorage.setItem("cot_pinned_symbols", JSON.stringify(state.pinnedSymbols));
      }

      function browserNotificationsSupported() {
        return typeof window !== "undefined" && "Notification" in window;
      }

      function saveAlertPreferences() {
        localStorage.setItem(ALERT_STORAGE.enabled, state.alertsEnabled ? "true" : "false");
        localStorage.setItem(ALERT_STORAGE.lead, String(state.alertLeadMinutes));
      }

      function saveAlertedEventKeys() {
        const keys = Array.from(state.alertedEventKeys);
        localStorage.setItem(ALERT_STORAGE.seen, JSON.stringify(keys.slice(-300)));
      }

      function loadAlertPreferences() {
        const leadRaw = Number(localStorage.getItem(ALERT_STORAGE.lead) || "15");
        state.alertLeadMinutes = [5, 10, 15, 30, 60].includes(leadRaw) ? leadRaw : 15;
        state.alertsEnabled = localStorage.getItem(ALERT_STORAGE.enabled) === "true";
        try {
          const parsed = JSON.parse(localStorage.getItem(ALERT_STORAGE.seen) || "[]");
          state.alertedEventKeys = new Set(Array.isArray(parsed) ? parsed : []);
        } catch (_) {
          state.alertedEventKeys = new Set();
        }
      }

      function updateAlertUI() {
        if (!el.alertLead || !el.alertToggle || !el.alertStatus) {
          return;
        }

        el.alertLead.value = String(state.alertLeadMinutes);
        const supported = browserNotificationsSupported();

        if (!supported) {
          el.alertLead.disabled = true;
          el.alertToggle.disabled = true;
          el.alertToggle.textContent = "Not Supported";
          el.alertStatus.textContent = "Browser notifications are not supported on this device.";
          return;
        }

        if (Notification.permission === "denied") {
          state.alertsEnabled = false;
          saveAlertPreferences();
          el.alertLead.disabled = true;
          el.alertToggle.disabled = false;
          el.alertToggle.textContent = "Alerts Blocked";
          el.alertStatus.textContent = "Notifications are blocked in browser settings.";
          return;
        }

        el.alertLead.disabled = false;
        el.alertToggle.disabled = false;
        if (state.alertsEnabled && Notification.permission === "granted") {
          el.alertToggle.textContent = "Alerts On";
          el.alertStatus.textContent = `Will alert ${state.alertLeadMinutes} min before each major event (while tab is open).`;
        } else {
          el.alertToggle.textContent = "Enable Alerts";
          el.alertStatus.textContent = `Alerts off. Enable browser notifications for ${state.alertLeadMinutes} min pre-news popups.`;
        }
      }

      function scheduleNewsAlertPolling() {
        if (state.alertTimerId) {
          clearInterval(state.alertTimerId);
          state.alertTimerId = null;
        }
        if (!state.alertsEnabled) {
          return;
        }
        state.alertTimerId = window.setInterval(() => {
          maybeSendNewsAlerts();
        }, 30000);
      }

      async function enableNewsAlerts() {
        if (!browserNotificationsSupported()) {
          updateAlertUI();
          return;
        }

        let permission = Notification.permission;
        if (permission !== "granted") {
          permission = await Notification.requestPermission();
        }
        if (permission === "granted") {
          state.alertsEnabled = true;
          saveAlertPreferences();
          scheduleNewsAlertPolling();
          maybeSendNewsAlerts();
        } else {
          state.alertsEnabled = false;
          saveAlertPreferences();
        }
        updateAlertUI();
      }

      function disableNewsAlerts() {
        state.alertsEnabled = false;
        saveAlertPreferences();
        scheduleNewsAlertPolling();
        updateAlertUI();
      }

      function maybeSendNewsAlerts() {
        if (!state.alertsEnabled) return;
        if (!browserNotificationsSupported() || Notification.permission !== "granted") return;

        const events = state.snapshot?.forex_factory?.upcoming_red_folder || [];
        const nowMs = Date.now();
        let changed = false;

        for (const key of Array.from(state.alertedEventKeys)) {
          const parts = key.split("|");
          const stamp = Date.parse(parts[0] || "");
          if (Number.isFinite(stamp) && stamp < nowMs - 36 * 60 * 60 * 1000) {
            state.alertedEventKeys.delete(key);
            changed = true;
          }
        }

        for (const event of events) {
          const eventMs = Date.parse(event.datetime_utc || "");
          if (!Number.isFinite(eventMs)) continue;

          const leadMs = state.alertLeadMinutes * 60 * 1000;
          const triggerMs = eventMs - leadMs;
          if (nowMs < triggerMs || nowMs > eventMs + 5 * 60 * 1000) continue;

          const key = `${event.datetime_utc || ""}|${event.title || ""}|${state.alertLeadMinutes}`;
          if (state.alertedEventKeys.has(key)) continue;

          const minsLeft = Math.max(0, Math.round((eventMs - nowMs) / 60000));
          const title = `${event.country || "USD"} news in ${minsLeft}m`;
          const body = `${event.title || "Major event"} â€¢ ${fmtLocal(event.datetime_utc, true)}`;

          try {
            new Notification(title, { body, tag: key, renotify: false });
          } catch (_) {
            continue;
          }

          state.alertedEventKeys.add(key);
          changed = true;
        }

        if (changed) {
          saveAlertedEventKeys();
        }
      }

      function githubApiHeaders(token) {
        return {
          Accept: "application/vnd.github+json",
          Authorization: `Bearer ${token}`,
          "X-GitHub-Api-Version": "2022-11-28",
          "Content-Type": "application/json",
        };
      }

      function getGitHubToken() {
        const stored = localStorage.getItem(GITHUB_REFRESH.tokenStorageKey);
        if (stored && stored.trim()) {
          return stored.trim();
        }

        const entered = window.prompt(
          "Paste a GitHub token (Actions:Read/Write) to run live refresh. Cancel = only reload currently deployed data."
        );
        if (!entered || !entered.trim()) {
          return null;
        }

        const token = entered.trim();
        localStorage.setItem(GITHUB_REFRESH.tokenStorageKey, token);
        return token;
      }

      function clearGitHubToken() {
        localStorage.removeItem(GITHUB_REFRESH.tokenStorageKey);
      }

      async function dispatchRefreshWorkflow(token) {
        const url = `https://api.github.com/repos/${GITHUB_REFRESH.owner}/${GITHUB_REFRESH.repo}/actions/workflows/${GITHUB_REFRESH.workflowFile}/dispatches`;
        const response = await fetch(url, {
          method: "POST",
          headers: githubApiHeaders(token),
          body: JSON.stringify({ ref: GITHUB_REFRESH.ref }),
        });

        if (!response.ok) {
          const detail = await response.text();
          throw new Error(`Dispatch failed (${response.status}): ${detail || "unknown error"}`);
        }
      }

      async function fetchRecentWorkflowRuns(token) {
        const url = `https://api.github.com/repos/${GITHUB_REFRESH.owner}/${GITHUB_REFRESH.repo}/actions/workflows/${GITHUB_REFRESH.workflowFile}/runs?event=workflow_dispatch&branch=${GITHUB_REFRESH.ref}&per_page=10`;
        const response = await fetch(url, { headers: githubApiHeaders(token) });
        if (!response.ok) {
          const detail = await response.text();
          throw new Error(`Run lookup failed (${response.status}): ${detail || "unknown error"}`);
        }

        const payload = await response.json();
        return Array.isArray(payload.workflow_runs) ? payload.workflow_runs : [];
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function waitForWorkflowCompletion(token, dispatchedAtMs, timeoutMs = 300000) {
        const deadline = Date.now() + timeoutMs;
        let trackedRunId = null;

        while (Date.now() < deadline) {
          const runs = await fetchRecentWorkflowRuns(token);

          let run = null;
          if (trackedRunId) {
            run = runs.find((item) => item.id === trackedRunId) || null;
          } else {
            run =
              runs.find((item) => {
                const createdAtMs = new Date(item.created_at).getTime();
                return createdAtMs >= dispatchedAtMs - 45000;
              }) || null;
            if (run) {
              trackedRunId = run.id;
            }
          }

          if (run) {
            if (run.status === "completed") {
              if (run.conclusion === "success") {
                return { ok: true, run };
              }
              return { ok: false, error: `Workflow finished: ${run.conclusion || "unknown"}`, run };
            }
            el.syncState.textContent = `Running (${run.status})`;
          } else {
            el.syncState.textContent = "Queued";
          }

          await sleep(4500);
        }

        return { ok: false, error: "Timed out waiting for refresh workflow." };
      }

      function fmtNum(value, digits = 0) {
        const num = Number(value);
        if (Number.isNaN(num)) return "--";
        return num.toLocaleString(undefined, { minimumFractionDigits: digits, maximumFractionDigits: digits });
      }

      function fmtSigned(value, digits = 0) {
        const num = Number(value);
        if (Number.isNaN(num)) return "--";
        return `${num > 0 ? "+" : ""}${fmtNum(num, digits)}`;
      }

      function fmtPct(value, digits = 2) {
        const num = Number(value);
        if (Number.isNaN(num)) return "--";
        return `${num > 0 ? "+" : ""}${num.toFixed(digits)}%`;
      }

      function fmtDate(value) {
        if (!value) return "--";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return String(value);
        return dt.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
      }

      function fmtET(value, withYear = false) {
        if (!value) return "--";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return String(value);
        return dt.toLocaleString(undefined, {
          timeZone: "America/New_York",
          month: "short",
          day: "numeric",
          year: withYear ? "numeric" : undefined,
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function fmtLocal(value, withYear = false) {
        if (!value) return "--";
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return String(value);
        return dt.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          year: withYear ? "numeric" : undefined,
          hour: "2-digit",
          minute: "2-digit",
          timeZoneName: "short",
        });
      }

      function safeScore(value) {
        const num = Number(value);
        if (Number.isNaN(num)) return 50;
        return Math.max(0, Math.min(100, num));
      }

      function tone(label) {
        if (label === "BULLISH") return "is-bull";
        if (label === "BEARISH") return "is-bear";
        return "is-neutral";
      }

      function accent(label) {
        if (label === "BULLISH") return "var(--bull)";
        if (label === "BEARISH") return "var(--bear)";
        return "var(--neutral)";
      }

      function marketOrder() {
        const markets = state.snapshot?.markets || {};
        const base = state.snapshot?.market_order || DEFAULT_MARKET_ORDER;
        return base.filter((key) => markets[key]).concat(Object.keys(markets).filter((key) => !base.includes(key)));
      }

      function activeMarket() {
        const markets = state.snapshot?.markets || {};
        if (markets[state.activeMarket]) {
          return markets[state.activeMarket];
        }
        const key = marketOrder()[0];
        if (!key) return null;
        state.activeMarket = key;
        return markets[key];
      }

      function renderTabs() {
        const markets = state.snapshot?.markets || {};
        el.marketTabs.innerHTML = "";

        marketOrder().forEach((key) => {
          const market = markets[key];
          const button = document.createElement("button");
          button.className = `market-tab ${key === state.activeMarket ? "active" : ""}`;
          button.textContent = `${market.label} (${market.symbol || ""})`;
          button.addEventListener("click", () => {
            state.activeMarket = key;
            renderDashboard();
          });
          el.marketTabs.appendChild(button);
        });
      }

      function renderSync(market) {
        const generated = state.snapshot?.generated_at_utc;
        const pulse = market?.intraday?.as_of_utc;
        const latestReport = market?.latest_report_date;

        el.syncState.textContent = "Live";
        el.syncDot.style.background = "var(--bull)";
        el.syncDot.style.boxShadow = "0 0 16px var(--bull)";
        el.syncTime.textContent = `COT ${fmtDate(latestReport)} | Pulse ${fmtET(pulse || generated)} ET`;
      }

      function renderHero(market) {
        const confluence = market.confluence || {};
        const label = confluence.label || "NEUTRAL";
        const score = safeScore(confluence.score);
        const accentColor = accent(label);

        el.heroMarket.textContent = `${market.label} bias for next 1-5 sessions`;

        el.biasScore.textContent = fmtNum(score);
        el.biasWord.textContent = label;
        el.biasWord.classList.remove("is-bull", "is-bear", "is-neutral", "text-emerald-400", "text-rose-400", "text-amber-400");
        if (label === "BULLISH") {
          el.biasWord.classList.add("is-bull", "text-emerald-400");
        } else if (label === "BEARISH") {
          el.biasWord.classList.add("is-bear", "text-rose-400");
        } else {
          el.biasWord.classList.add("is-neutral", "text-amber-400");
        }

        el.biasGauge.style.setProperty("--score", score);
        el.biasGauge.style.setProperty("--accent", accentColor);
        el.biasGauge.classList.toggle("pulse", score >= 85);

        el.confluenceLine.textContent = `COT ${fmtNum(confluence.cot_score)} + Technical ${fmtNum(
          confluence.technical_score
        )} = ${fmtNum(score)}% confluence`;
        el.confluenceFill.style.width = `${score}%`;
        el.confluenceFill.style.background = accentColor;

        el.playbookLine.textContent = confluence.headline || "Waiting for confluence playbook.";
        el.playbookList.innerHTML = (confluence.bullets || []).map((line) => `<li class="list-disc ml-5">${line}</li>`).join("");
      }

      function renderIntraday(market) {
        const intraday = market.intraday;
        if (!intraday) {
          el.pulseTag.textContent = "No data";
          el.pulseTag.className = "pill";
          el.pulseScore.textContent = "--";
          el.priceValue.textContent = "--";
          el.priceChange.textContent = "Intraday feed unavailable";
          el.sessionStructure.textContent = "--";
          el.sessionTime.textContent = "--";
          el.intradayMetrics.innerHTML = "";
          return;
        }

        const m = intraday.metrics || {};
        const pulseScore = safeScore(intraday.pulse_score);

        el.pulseTag.textContent = intraday.pulse_label || "--";
        el.pulseTag.className = `pill ${tone(intraday.pulse_label)}`;
        el.pulseScore.textContent = fmtNum(pulseScore);
        el.pulseScore.className = `v pulse-score ${tone(intraday.pulse_label)}`;

        const previousPrice = state.lastPriceByMarket[market.key];
        const currentPrice = Number(intraday.last_price);
        el.priceValue.textContent = `${intraday.symbol} ${fmtNum(currentPrice, 2)}`;
        if (!Number.isNaN(currentPrice) && previousPrice !== undefined && previousPrice !== currentPrice) {
          el.priceValue.classList.remove("flash-up", "flash-down");
          // Restart CSS animation by forcing reflow.
          void el.priceValue.offsetWidth;
          el.priceValue.classList.add(currentPrice > previousPrice ? "flash-up" : "flash-down");
          setTimeout(() => el.priceValue.classList.remove("flash-up", "flash-down"), 650);
        }
        if (!Number.isNaN(currentPrice)) {
          state.lastPriceByMarket[market.key] = currentPrice;
        }

        const dayChange = Number(intraday.day_change_pct);
        el.priceChange.textContent = `${fmtPct(dayChange)} today`;
        el.priceChange.className = `price-change ${dayChange >= 0 ? "is-bull" : "is-bear"}`;

        el.sessionStructure.textContent = m.session_structure || "--";
        el.sessionTime.textContent = `As of ${fmtET(intraday.as_of_utc)} ET`;
        el.pulseKicker.textContent = `${m.opening_range_state || ""} | ${m.ema_stack || ""}`;

        const chips = [
          `VWAP ${fmtPct(m.price_vs_vwap_pct)}`,
          `Pivot ${fmtPct(m.price_vs_pivot_pct)}`,
          `OR ${fmtNum(m.opening_range_low, 2)}-${fmtNum(m.opening_range_high, 2)}`,
          `EMA20 ${fmtNum(m.ema20, 2)} / EMA50 ${fmtNum(m.ema50, 2)}`,
        ];
        el.intradayMetrics.innerHTML = chips.map((item) => `<span class="chip">${item}</span>`).join("");
      }

      function scoreRow(label, value, groupLabel) {
        const score = safeScore(value);
        const fill = score >= 60 ? "var(--bull)" : score <= 40 ? "var(--bear)" : "var(--neutral)";
        return `
          <div class="row">
            <div class="row-head">
              <span class="muted">${label}</span>
              <span class="row-value">${fmtNum(score)}</span>
            </div>
            <div class="mini-bar"><span style="width:${score}%; background:${fill}"></span></div>
            <div class="kicker" style="margin:0.33rem 0 0">${groupLabel}</div>
          </div>
        `;
      }

      function valueRow(label, value, suffix = "") {
        return `
          <div class="row">
            <div class="row-head">
              <span class="muted">${label}</span>
              <span class="row-value">${value}${suffix}</span>
            </div>
          </div>
        `;
      }

      function renderDetails(market) {
        const comp = market.cot_bias?.components || {};
        el.componentGrid.innerHTML = [
          scoreRow("Institutional", comp.institutional_pressure, "Asset managers positioning"),
          scoreRow("Fast Money", comp.fast_money_pressure, "Leveraged fund pressure"),
          scoreRow("Momentum", comp.position_momentum, "Weekly directional shift"),
          scoreRow("Alignment", comp.alignment, "Institutional vs fast money agreement"),
        ].join("");

        const intraday = market.intraday;
        const latest = market.latest || {};
        const m = intraday?.metrics || {};

        el.levelGrid.innerHTML = [
          valueRow("VWAP", fmtNum(m.vwap, 2)),
          valueRow("Pivot", fmtNum(m.pivot, 2)),
          valueRow("Prior Day High", fmtNum(m.prior_day_high, 2)),
          valueRow("Prior Day Low", fmtNum(m.prior_day_low, 2)),
          valueRow("Asset Net", fmtSigned(latest.asset_mgr_net)),
          valueRow("Lev Net", fmtSigned(latest.leveraged_net)),
        ].join("");

        const releaseUtc = state.snapshot?.meta?.next_cot_release_utc;
        el.nextRelease.textContent = `Next COT: ${fmtET(releaseUtc)}`;
        el.detailKicker.textContent = `${market.contract_code} | Report ${fmtDate(market.latest_report_date)}`;
      }

      function renderEvents() {
        const rows = state.snapshot?.forex_factory?.upcoming_red_folder || [];
        el.redCount.textContent = `${rows.length} events`;

        if (!rows.length) {
          el.redEvents.innerHTML = `<div class="event"><div class="event-title">No high-impact events in feed</div></div>`;
          return;
        }

        el.redEvents.innerHTML = rows
          .map(
            (item) => `
              <article class="event">
                <div class="event-top">
                  <div class="event-title">${item.title || "Event"}</div>
                  <div class="event-tag">Red</div>
                </div>
                <div class="event-meta">${item.country || "--"} | ${fmtLocal(item.datetime_utc, true)}</div>
              </article>
            `
          )
          .join("");
      }

      function renderCOTChart(market) {
        const history = market.history || [];
        if (!history.length) return;

        const x = history.map((row) => row.report_date);

        let traces = [];
        if (state.chartMode === "trend") {
          traces = [
            {
              type: "scatter",
              mode: "lines+markers",
              name: "Asset Net",
              x,
              y: history.map((row) => row.asset_mgr_net),
              line: { color: "#f59e0b", width: 2.4 },
              marker: { size: 4, color: "#f59e0b" },
            },
            {
              type: "scatter",
              mode: "lines+markers",
              name: "Lev Net",
              x,
              y: history.map((row) => row.leveraged_net),
              line: { color: "#38bdf8", width: 2.4 },
              marker: { size: 4, color: "#38bdf8" },
            },
            {
              type: "bar",
              name: "Open Interest",
              x,
              y: history.map((row) => row.open_interest),
              yaxis: "y2",
              marker: { color: "rgba(148, 163, 184, 0.24)" },
            },
          ];
          el.chartTitle.textContent = `${market.label} Positioning Trend`;
        } else {
          const shift = history.map((row, idx) => {
            if (idx === 0) return 0;
            const curr = row.asset_mgr_net + row.leveraged_net;
            const prev = history[idx - 1].asset_mgr_net + history[idx - 1].leveraged_net;
            return curr - prev;
          });

          traces = [
            {
              type: "bar",
              name: "Weekly Net Shift",
              x,
              y: shift,
              marker: {
                color: shift.map((val) => (val >= 0 ? "rgba(52,211,153,0.76)" : "rgba(251,113,133,0.76)")),
              },
            },
          ];
          el.chartTitle.textContent = `${market.label} Weekly Shift`;
        }

        el.chartSub.textContent = `${market.contract_code} | latest report ${fmtDate(market.latest_report_date)}`;

        const dark = state.theme === "dark";
        const layout = {
          margin: { l: 48, r: 52, t: 8, b: 36 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: dark ? "rgba(14,18,26,0.78)" : "rgba(255,255,255,0.74)",
          font: { family: "Inter, -apple-system, BlinkMacSystemFont, sans-serif", color: dark ? "#d5dbe8" : "#334155" },
          hovermode: "x unified",
          legend: { orientation: "h", y: 1.12, x: 0 },
          xaxis: {
            type: "date",
            tickformat: "%b '%y",
            gridcolor: dark ? "rgba(148,163,184,0.12)" : "rgba(100,116,139,0.16)",
          },
          yaxis: {
            title: state.chartMode === "trend" ? "Net Contracts" : "Weekly Shift",
            gridcolor: dark ? "rgba(148,163,184,0.12)" : "rgba(100,116,139,0.16)",
          },
          yaxis2: {
            title: "Open Interest",
            overlaying: "y",
            side: "right",
            showgrid: false,
          },
        };

        Plotly.react("cot-chart", traces, layout, { displayModeBar: false, responsive: true });
      }

      function renderPulseChart(market) {
        const intraday = market.intraday;
        if (!intraday) {
          Plotly.react(
            "pulse-chart",
            [],
            {
              margin: { l: 20, r: 20, t: 12, b: 20 },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(0,0,0,0)",
              annotations: [
                {
                  text: "Intraday data unavailable",
                  showarrow: false,
                  x: 0.5,
                  y: 0.5,
                  xref: "paper",
                  yref: "paper",
                  font: { color: "#94a3b8" },
                },
              ],
            },
            { displayModeBar: false, responsive: true }
          );
          return;
        }

        const today = intraday.spark?.today || [];
        const yesterday = intraday.spark?.yesterday || [];

        const traces = [
          {
            type: "scatter",
            mode: "lines",
            name: "Today",
            x: today.map((row) => row.t),
            y: today.map((row) => row.p),
            line: { color: "#4f9cf7", width: 2.4 },
          },
          {
            type: "scatter",
            mode: "lines",
            name: "Yesterday",
            x: yesterday.map((row) => row.t),
            y: yesterday.map((row) => row.p),
            line: { color: "#9ca3af", width: 1.8, dash: "dot" },
          },
        ];

        const dark = state.theme === "dark";
        const layout = {
          margin: { l: 46, r: 12, t: 8, b: 30 },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: dark ? "rgba(14,18,26,0.78)" : "rgba(255,255,255,0.74)",
          font: { family: "Inter, -apple-system, BlinkMacSystemFont, sans-serif", color: dark ? "#d5dbe8" : "#334155" },
          legend: { orientation: "h", y: 1.14, x: 0 },
          hovermode: "x",
          xaxis: {
            type: "date",
            tickformat: "%H:%M",
            gridcolor: dark ? "rgba(148,163,184,0.1)" : "rgba(100,116,139,0.13)",
          },
          yaxis: {
            tickformat: ".2f",
            gridcolor: dark ? "rgba(148,163,184,0.1)" : "rgba(100,116,139,0.13)",
          },
        };

        Plotly.react("pulse-chart", traces, layout, { displayModeBar: false, responsive: true });
      }

      function renderHistory(market) {
        const rows = (market.history || []).slice(-10).reverse();
        el.historyCaption.textContent = `${market.label} | ${market.contract_code}`;
        el.historyBody.innerHTML = rows
          .map(
            (row) => `
              <tr>
                <td>${fmtDate(row.report_date)}</td>
                <td>${fmtSigned(row.asset_mgr_net)}</td>
                <td>${fmtSigned(row.leveraged_net)}</td>
                <td>${fmtNum(row.open_interest)}</td>
              </tr>
            `
          )
          .join("");
      }

      function watchCard(item) {
        const score = item.confluence_score;
        const label = item.confluence_label || item.pulse_label || "NEUTRAL";
        const scoreText = score === null || score === undefined ? "N/A" : `${fmtNum(score)} ${label}`;

        return `
          <article class="watch ${item.market_key === state.activeMarket ? "active" : ""}" data-symbol="${item.symbol}" data-market="${
          item.market_key || ""
        }">
            <div class="watch-top">
              <span class="watch-symbol">${item.symbol}</span>
              <button class="watch-remove" data-remove="${item.symbol}" aria-label="Remove ${item.symbol}">Ã—</button>
            </div>
            <div class="watch-score ${tone(label)}">${scoreText}</div>
            <div class="watch-meta">${item.cot_score === null ? "COT N/A" : `COT ${fmtNum(item.cot_score)}`} | ${
          item.pulse_score === null ? "Pulse N/A" : `Pulse ${fmtNum(item.pulse_score)}`
        }</div>
          </article>
        `;
      }

      function renderWatchlist() {
        const watchlist = state.snapshot?.watchlist || {};
        const symbols = Object.keys(watchlist);
        if (!symbols.length) {
          el.watchGrid.innerHTML = "";
          return;
        }

        state.pinnedSymbols = state.pinnedSymbols.filter((symbol) => symbols.includes(symbol));
        if (!state.pinnedSymbols.length) {
          state.pinnedSymbols = symbols.slice(0, 3);
        }

        el.watchGrid.innerHTML = state.pinnedSymbols.map((symbol) => watchCard(watchlist[symbol])).join("");

        el.watchGrid.querySelectorAll("[data-remove]").forEach((node) => {
          node.addEventListener("click", (event) => {
            event.stopPropagation();
            const symbol = node.getAttribute("data-remove");
            state.pinnedSymbols = state.pinnedSymbols.filter((key) => key !== symbol);
            if (!state.pinnedSymbols.length) {
              state.pinnedSymbols = symbols.slice(0, 1);
            }
            savePinned();
            renderWatchlist();
          });
        });

        el.watchGrid.querySelectorAll(".watch").forEach((card) => {
          card.addEventListener("click", () => {
            const marketKey = card.getAttribute("data-market");
            if (marketKey && state.snapshot.markets[marketKey]) {
              state.activeMarket = marketKey;
              renderDashboard();
            }
          });
        });

        el.symbolPicker.innerHTML = symbols
          .map((symbol) => {
            const item = watchlist[symbol];
            const disabled = state.pinnedSymbols.includes(symbol) ? "disabled" : "";
            return `<option value="${symbol}" ${disabled}>${item.label}</option>`;
          })
          .join("");
      }

      function renderDashboard() {
        if (!state.snapshot?.markets) return;
        const market = activeMarket();
        if (!market) return;

        renderTabs();
        renderSync(market);
        renderHero(market);
        renderIntraday(market);
        renderDetails(market);
        renderEvents();
        renderCOTChart(market);
        renderPulseChart(market);
        renderWatchlist();
        renderHistory(market);
        updateAlertUI();
      }

      function setLoadingSync(isLoading, loadingText = "Syncing...") {
        el.syncBtn.disabled = isLoading;
        el.syncBtn.textContent = isLoading ? loadingText : "Sync";
      }

      async function loadSnapshot(manual = false) {
        setLoadingSync(manual);
        try {
          const response = await fetch(`./data/cot_snapshot.json?ts=${Date.now()}`, { cache: "no-store" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const payload = await response.json();
          if (!payload?.markets || !Object.keys(payload.markets).length) {
            throw new Error("Snapshot format invalid");
          }

          state.snapshot = payload;
          if (!payload.markets[state.activeMarket]) {
            state.activeMarket = marketOrder()[0] || Object.keys(payload.markets)[0];
          }

          el.errorBox.classList.add("hidden");
          el.errorBox.textContent = "";
          renderDashboard();
          maybeSendNewsAlerts();
        } catch (error) {
          el.syncDot.style.background = "var(--bear)";
          el.syncDot.style.boxShadow = "0 0 16px var(--bear)";
          el.syncState.textContent = "Offline";
          el.errorBox.classList.remove("hidden");
          el.errorBox.textContent = `Failed to load snapshot: ${error.message}`;
        } finally {
          setLoadingSync(false);
        }
      }

      async function runSyncAction() {
        if (state.refreshInFlight) {
          return;
        }

        state.refreshInFlight = true;
        setLoadingSync(true, "Starting...");

        try {
          const token = getGitHubToken();
          if (!token) {
            el.syncState.textContent = "Reloading";
            await loadSnapshot(false);
            return;
          }

          const dispatchedAtMs = Date.now();
          setLoadingSync(true, "Dispatching...");
          el.syncState.textContent = "Dispatching";
          await dispatchRefreshWorkflow(token);

          setLoadingSync(true, "Running...");
          const result = await waitForWorkflowCompletion(token, dispatchedAtMs);
          if (!result.ok) {
            throw new Error(result.error || "Refresh workflow failed.");
          }

          setLoadingSync(true, "Loading...");
          el.syncState.textContent = "Updating";
          await loadSnapshot(false);
        } catch (error) {
          const message = String(error?.message || error);
          if (message.includes("401") || message.includes("403")) {
            clearGitHubToken();
          }
          el.syncDot.style.background = "var(--bear)";
          el.syncDot.style.boxShadow = "0 0 16px var(--bear)";
          el.syncState.textContent = "Sync failed";
          el.errorBox.classList.remove("hidden");
          el.errorBox.textContent = `Sync failed: ${message}`;
        } finally {
          state.refreshInFlight = false;
          setLoadingSync(false);
        }
      }

      function bindEvents() {
        el.themeToggle.addEventListener("click", () => {
          setTheme(state.theme === "dark" ? "light" : "dark");
          renderDashboard();
        });

        if (el.alertToggle) {
          el.alertToggle.addEventListener("click", async () => {
            if (state.alertsEnabled) {
              disableNewsAlerts();
            } else {
              await enableNewsAlerts();
            }
          });
        }

        if (el.alertLead) {
          el.alertLead.addEventListener("change", () => {
            const lead = Number(el.alertLead.value);
            if ([5, 10, 15, 30, 60].includes(lead)) {
              state.alertLeadMinutes = lead;
              state.alertedEventKeys = new Set();
              saveAlertedEventKeys();
              saveAlertPreferences();
              updateAlertUI();
              maybeSendNewsAlerts();
            }
          });
        }

        el.syncBtn.addEventListener("click", () => {
          runSyncAction();
        });

        el.modeTrend.addEventListener("click", () => {
          state.chartMode = "trend";
          el.modeTrend.classList.add("active");
          el.modeShift.classList.remove("active");
          renderCOTChart(activeMarket());
        });

        el.modeShift.addEventListener("click", () => {
          state.chartMode = "shift";
          el.modeShift.classList.add("active");
          el.modeTrend.classList.remove("active");
          renderCOTChart(activeMarket());
        });

        el.pinSymbol.addEventListener("click", () => {
          const symbol = el.symbolPicker.value;
          if (!symbol || state.pinnedSymbols.includes(symbol)) {
            return;
          }
          state.pinnedSymbols.push(symbol);
          if (state.pinnedSymbols.length > 6) {
            state.pinnedSymbols = state.pinnedSymbols.slice(-6);
          }
          savePinned();
          renderWatchlist();
        });

        document.addEventListener("keydown", (event) => {
          const tag = String(event.target?.tagName || "").toLowerCase();
          if (["input", "textarea", "select"].includes(tag)) {
            return;
          }

          if (event.key === "1") {
            state.activeMarket = "dow_jones";
            renderDashboard();
          }
          if (event.key === "2") {
            state.activeMarket = "nasdaq_100";
            renderDashboard();
          }
          if (event.key === "3") {
            state.activeMarket = "sp_500";
            renderDashboard();
          }
          if (event.key === "4") {
            state.activeMarket = "dxy";
            renderDashboard();
          }
          if (event.key === "/") {
            event.preventDefault();
            el.symbolPicker.focus();
          }
        });
      }

      loadPinned();
      loadAlertPreferences();
      setTheme(state.theme);
      updateAlertUI();
      scheduleNewsAlertPolling();
      bindEvents();
      loadSnapshot();
    </script>
  </body>
</html>
